---
# Install MySQL server
- name: Install MySQL server
  ansible.builtin.apt:
    name: mysql-server
    state: present
    update_cache: yes

# Install PyMySQL for MySQL connectivity
- name: Install PyMySQL
  ansible.builtin.apt:
    name: python3-pymysql
    state: present

# Ensure MySQL service is started and enabled
- name: Ensure MySQL service is running
  ansible.builtin.service:
    name: mysql
    state: started
    enabled: true

- name: Wait for MySQL to be ready
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: 3306
    delay: 5
    timeout: 30
    state: started

# Create override configuration for MySQL to bind to 0.0.0.0
- name: Create MySQL override configuration
  ansible.builtin.copy:
    dest: /etc/mysql/mysql.conf.d/override.cnf
    content: |
      [mysqld]
      bind-address = 0.0.0.0
  notify: Restart MySQL

# Create MySQL database
- name: MySQL database
  community.mysql.mysql_db:
    name: "{{ mysql_database }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock

# Create MySQL user for the web application
- name: MySQL user
  community.mysql.mysql_user:
    name: "{{ mysql_user }}"
    password: "{{ mysql_password }}"
    host: "%"
    priv: "{{ mysql_database }}.*:ALL"
    login_unix_socket: /var/run/mysqld/mysqld.sock

# Install MySQL exporter
- name: Install MySQL exporter
  ansible.builtin.apt:
    name: prometheus-mysqld-exporter
    state: present
    update_cache: yes

# Create MySQL user for the exporter
- name: Create MySQL user for exporter
  community.mysql.mysql_user:
    name: mysql_exporter
    password: "{{ mysql_exporter_password }}"
    priv: "*.*:PROCESS,REPLICATION CLIENT"
    login_unix_socket: /var/run/mysqld/mysqld.sock

# Configure MySQL exporter credentials
- name: Configure MySQL exporter credentials
  ansible.builtin.copy:
    content: |
      [client]
      user=mysql_exporter
      password={{ mysql_exporter_password }}
    dest: /var/lib/prometheus/.my.cnf
    owner: prometheus
    group: prometheus
    mode: "0600"
  notify: Restart MySQL Exporter

# Ensure /home/backup/mysql directory exists
- name: Ensure /home/backup/mysql directory exists
  ansible.builtin.file:
    path: /home/backup/mysql
    state: directory
    owner: backup
    group: backup
    mode: '0755'

# Create MySQL backup user
- name: Create MySQL backup user
  community.mysql.mysql_user:
    name: backup
    host: '%'
    password: "{{ mysql_backup_password }}"
    priv: "agama.*:LOCK TABLES,SELECT"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    state: present
  become: true
  become_user: root

# Create MySQL client configuration file for backup user
- name: Create MySQL client configuration file for backup user
  ansible.builtin.copy:
    dest: /home/backup/.my.cnf
    content: |
      [client]
      user=backup
      password={{ mysql_backup_password }}
      [mysqldump]
      no_tablespaces
    owner: backup
    group: backup
    mode: '0600'

# Ensure /home/backup/mysql directory exists
- name: Ensure /home/backup/mysql directory exists
  ansible.builtin.file:
    path: /home/backup/mysql
    state: directory
    owner: backup
    group: backup
    mode: '0755'

# Create Cron job for MySQL backups
- name: Create Cron job for MySQL backups
  ansible.builtin.copy:
    content: |
      PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
      {{ mysql_backup_schedule }} backup mysqldump agama > /home/backup/mysql/agama.sql
      12 0 * * 0  backup  duplicity --no-encryption full /home/backup/mysql/ rsync://andriikuiava@{{ backup_domain }}/mysql
      12 0 * * 1-6  backup  duplicity --no-encryption incremental /home/backup/mysql/ rsync://andriikuiava@{{ backup_domain }}/mysql
    dest: /etc/cron.d/mysql-backup
    owner: root
    group: root
    mode: '0644'
  notify: Restart Cron

# Create MySQL replication user
- name: Create MySQL replication user
  community.mysql.mysql_user:
    name: replication
    login_unix_socket: /var/run/mysqld/mysqld.sock
    password: "{{ replication_password }}"
    priv: '*.*:REPLICATION SLAVE'
    host: '%'
    state: present
  register: mysql_replication_user




## Create override configuration for MySQL exporter
#- name: Restart MySQL exporter if credentials change
#  ansible.builtin.systemd:
#    name: prometheus-mysqld-exporter
#    state: restarted
#  notify: Restart MySQL Exporter