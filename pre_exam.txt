Fri Jan  3 11:36:28 EET 2025
+ hostname
andriis-MacBook-Air.local
+ ansible-playbook infra.yaml --diff

PLAY [Always gather facts for all hosts] ***************************************

TASK [Gathering Facts] *********************************************************
[WARNING]: Platform linux on host andriikuiava-2 is using the discovered Python
interpreter at /usr/bin/python3.10, but future installation of another Python
interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
[WARNING]: Platform linux on host andriikuiava-1 is using the discovered Python
interpreter at /usr/bin/python3.10, but future installation of another Python
interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
[WARNING]: Platform linux on host andriikuiava-3 is using the discovered Python
interpreter at /usr/bin/python3.10, but future installation of another Python
interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
ok: [andriikuiava-2]
ok: [andriikuiava-1]
ok: [andriikuiava-3]

PLAY [Initial setup] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [init : Update APT cache] *************************************************
changed: [andriikuiava-3]
changed: [andriikuiava-2]
changed: [andriikuiava-1]

TASK [init : Install Prometheus Node Exporter] *********************************
The following additional packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter-collectors smartmontools
Suggested packages:
  gsmartcontrol smart-notifier mailx | mailutils
The following NEW packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter prometheus-node-exporter-collectors
  smartmontools
0 upgraded, 8 newly installed, 0 to remove and 133 not upgraded.
changed: [andriikuiava-1]
The following additional packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter-collectors smartmontools
Suggested packages:
  gsmartcontrol smart-notifier mailx | mailutils
The following NEW packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter prometheus-node-exporter-collectors
  smartmontools
0 upgraded, 8 newly installed, 0 to remove and 133 not upgraded.
changed: [andriikuiava-3]
The following additional packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter-collectors smartmontools
Suggested packages:
  gsmartcontrol smart-notifier mailx | mailutils
The following NEW packages will be installed:
  libio-pty-perl libipc-run-perl libtime-duration-perl libtimedate-perl
  moreutils prometheus-node-exporter prometheus-node-exporter-collectors
  smartmontools
0 upgraded, 8 newly installed, 0 to remove and 133 not upgraded.
changed: [andriikuiava-2]

TASK [init : Ensure Prometheus Node Exporter service is running] ***************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [init : Ensure rsyslog is installed] **************************************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [init : Copy rsyslog configuration for Telegraf] **************************
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmp49cskg1c/50-telegraf.conf.j2
@@ -0,0 +1,6 @@
+$ActionQueueType LinkedList
+$ActionQueueFileName srvrfwd
+$ActionResumeRetryCount -1
+$ActionQueueSaveOnShutdown on
+
+*.* @influxdb.megacoolproject.io:6514;RSYSLOG_SyslogProtocol23Format
\ No newline at end of file

changed: [andriikuiava-3]
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmp45lywqfz/50-telegraf.conf.j2
@@ -0,0 +1,6 @@
+$ActionQueueType LinkedList
+$ActionQueueFileName srvrfwd
+$ActionResumeRetryCount -1
+$ActionQueueSaveOnShutdown on
+
+*.* @influxdb.megacoolproject.io:6514;RSYSLOG_SyslogProtocol23Format
\ No newline at end of file

changed: [andriikuiava-2]
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpkzxgaxi9/50-telegraf.conf.j2
@@ -0,0 +1,6 @@
+$ActionQueueType LinkedList
+$ActionQueueFileName srvrfwd
+$ActionResumeRetryCount -1
+$ActionQueueSaveOnShutdown on
+
+*.* @influxdb.megacoolproject.io:6514;RSYSLOG_SyslogProtocol23Format
\ No newline at end of file

changed: [andriikuiava-1]

TASK [init : Ensure backup user exists with the correct home directory] ********
changed: [andriikuiava-1]
changed: [andriikuiava-2]
changed: [andriikuiava-3]

TASK [init : Ensure .ssh directory exists for backup user] *********************
--- before
+++ after
@@ -1,7 +1,7 @@
 {
-    "group": 0,
-    "mode": "0755",
-    "owner": 0,
+    "group": 34,
+    "mode": "0700",
+    "owner": 34,
     "path": "/home/backup/.ssh",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-1]
--- before
+++ after
@@ -1,7 +1,7 @@
 {
-    "group": 0,
-    "mode": "0755",
-    "owner": 0,
+    "group": 34,
+    "mode": "0700",
+    "owner": 34,
     "path": "/home/backup/.ssh",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-3]
--- before
+++ after
@@ -1,7 +1,7 @@
 {
-    "group": 0,
-    "mode": "0755",
-    "owner": 0,
+    "group": 34,
+    "mode": "0700",
+    "owner": 34,
     "path": "/home/backup/.ssh",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-2]

TASK [init : Check if SSH key pair exists] *************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]
ok: [andriikuiava-3]

TASK [init : Generate SSH key pair for backup user] ****************************
--- before
+++ after
@@ -1 +1,8 @@
-{}
+{
+    "comment": "",
+    "fingerprint": "SHA256:LEE9qi0DXoLk7XOlL+GLQ0wW6Fs3LYX7K57QMpEtFXo",
+    "format": "",
+    "public_key": "AAAAB3NzaC1yc2EAAAADAQABAAABAQDQ/vfjEwqKHiRDBzT0OuGIuGEJlwJjkCOD7eC124koOgz6r6vVgVzSQ1SOxCOvUhhsPP/LV7Vskomaj8OpGqVQIdECkkZ88pjfBcPab3Z5WdwZx6LhzRpDefQ9Y2HJqKrh6ef5p0S4IBoZWroexlHeIGscl05JKayhhLSLIzWVkeEu42CCXybJzNO0l0I9LNxDHC+XldTPLiCivyZVeW4woU3rCp90I29+i2ywR0cfxeacoGaCe+apEqSF16euj+QEm3qsO0e/6qSXEXpCYDZx35HglP+oWXKMehGg39H1IfoNGt4lq7fdALamIkHLjwv1xIJuSLTVokPeuxVx/RMJ",
+    "size": 2048,
+    "type": "rsa"
+}

changed: [andriikuiava-3]
--- before
+++ after
@@ -1 +1,8 @@
-{}
+{
+    "comment": "",
+    "fingerprint": "SHA256:nb0FWPl98vDYCVRP9izNmH3IFyli/7YtbJ92vx+Vyy4",
+    "format": "",
+    "public_key": "AAAAB3NzaC1yc2EAAAADAQABAAABAQDArxHMQTBCd+I6mm5+HQ30YDmv1I+jVA01m6UIrYx59DYcRlkB5pvZKpiCFZC6pdG/wl7Bcxqiu6zoJnDihl9p/fblpzRlZJD6ZsQX0wcQzr+Lqk4VvCBT+9SODuGuhl2nzdf4owLFudH9niLiek0MyRe0ZUa8mS7qmKa891F7u6xDTaw+OYHswGyGfImUmd35898xxtU5UOz52/RjCwowKHq46jmbEqX0vOazcF4W96VUvmheZGEMclzFBgBek+l3giQUbEwrRO+7odVtqmC9s1yCNMROblI3n7zqBtFD4CQoIYqPJwW2jssbBg6/bK3R0yXn30iZKNqxCwVwz5Qv",
+    "size": 2048,
+    "type": "rsa"
+}

changed: [andriikuiava-2]
--- before
+++ after
@@ -1 +1,8 @@
-{}
+{
+    "comment": "",
+    "fingerprint": "SHA256:QdxVELDIhKx3m8Y32x3jWwq2OtX55E6tjSCfkAM7JUU",
+    "format": "",
+    "public_key": "AAAAB3NzaC1yc2EAAAADAQABAAABAQDEHfFfonujc6dpBUBKro3Yc5+SVuhw55r0dHQKXVnxBDHpSRQLg+2+sZrtPdpHbc4M4yJiBtCvtspRVYeDENaIi5s7wNVD7q/wJ+S0YiqMZKbtNhWZAUOOwcy0kMWnLXMoSvpBZlfPqW9rDjcvs1z0cH9gYuODd+XyiggM2Z7ioTreCYCGWio5DU+Q5LNowycz4ue5btQPpwXuMrrtBvRIdnB8NHhUsOAGHgVk9uYpnt8LayGifMPnYJAe0u/qRsFnL2RvKkDohm+fXXVyIt0YDKEakqGfJ8hzdBwfJvfPpUKjeABedsXf0MAJFJL6zqVVAxk8tefFXaWersxMi8Hz",
+    "size": 2048,
+    "type": "rsa"
+}

changed: [andriikuiava-1]

TASK [init : Set permissions on the public key file] ***************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
-    "mode": "0600",
+    "mode": "0644",
     "path": "/home/backup/.ssh/id_rsa.pub"
 }

changed: [andriikuiava-2]
--- before
+++ after
@@ -1,4 +1,4 @@
 {
-    "mode": "0600",
+    "mode": "0644",
     "path": "/home/backup/.ssh/id_rsa.pub"
 }

changed: [andriikuiava-3]
--- before
+++ after
@@ -1,4 +1,4 @@
 {
-    "mode": "0600",
+    "mode": "0644",
     "path": "/home/backup/.ssh/id_rsa.pub"
 }

changed: [andriikuiava-1]

TASK [init : Ensure known_hosts file exists for backup user] *******************
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmp3hqwrhn4/known-hosts.j2
@@ -0,0 +1,3 @@
+192.168.42.132 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEu6pFFWyuRrl4WGFPQGElYN9txwTGm2wSntcpVAaN90
+backup ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEu6pFFWyuRrl4WGFPQGElYN9txwTGm2wSntcpVAaN90
+backup.megacoolproject.io ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEu6pFFWyuRrl4WGFPQGElYN9txwTGm2wSntcpVAaN90

changed: [andriikuiava-3]
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmp77o_en1r/known-hosts.j2
@@ -0,0 +1,3 @@
+192.168.42.132 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEu6pFFWyuRrl4WGFPQGElYN9txwTGm2wSntcpVAaN90
+backup ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEu6pFFWyuRrl4WGFPQGElYN9txwTGm2wSntcpVAaN90
+backup.megacoolproject.io ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEu6pFFWyuRrl4WGFPQGElYN9txwTGm2wSntcpVAaN90

changed: [andriikuiava-1]
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpq_k3y9w9/known-hosts.j2
@@ -0,0 +1,3 @@
+192.168.42.132 ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEu6pFFWyuRrl4WGFPQGElYN9txwTGm2wSntcpVAaN90
+backup ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEu6pFFWyuRrl4WGFPQGElYN9txwTGm2wSntcpVAaN90
+backup.megacoolproject.io ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEu6pFFWyuRrl4WGFPQGElYN9txwTGm2wSntcpVAaN90

changed: [andriikuiava-2]

TASK [init : Ensure backup user can access backup server without prompts] ******
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [init : Add backup server to known_hosts] *********************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [init : Set permissions for backup SSH keys] ******************************
ok: [andriikuiava-1] => (item=id_rsa)
ok: [andriikuiava-2] => (item=id_rsa)
ok: [andriikuiava-3] => (item=id_rsa)
ok: [andriikuiava-3] => (item=id_rsa.pub)
ok: [andriikuiava-1] => (item=id_rsa.pub)
ok: [andriikuiava-2] => (item=id_rsa.pub)

TASK [init : Ensure /home/backup/restore directory exists] *********************
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/restore",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-2]
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/restore",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-3]
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/restore",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-1]

TASK [init : Ensure duplicity is installed] ************************************
The following additional packages will be installed:
  librsync2 python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-nacl python3-paramiko
Suggested packages:
  python3-boto ncftp lftp tahoe-lafs python3-swiftclient python3-pip par2
  python-future-doc python-lockfile-doc python-nacl-doc python3-gssapi
  python3-invoke
The following NEW packages will be installed:
  duplicity librsync2 python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-nacl python3-paramiko
0 upgraded, 8 newly installed, 0 to remove and 133 not upgraded.
changed: [andriikuiava-3]
The following additional packages will be installed:
  librsync2 python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-nacl python3-paramiko
Suggested packages:
  python3-boto ncftp lftp tahoe-lafs python3-swiftclient python3-pip par2
  python-future-doc python-lockfile-doc python-nacl-doc python3-gssapi
  python3-invoke
The following NEW packages will be installed:
  duplicity librsync2 python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-nacl python3-paramiko
0 upgraded, 8 newly installed, 0 to remove and 133 not upgraded.
changed: [andriikuiava-1]
The following additional packages will be installed:
  librsync2 python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-nacl python3-paramiko
Suggested packages:
  python3-boto ncftp lftp tahoe-lafs python3-swiftclient python3-pip par2
  python-future-doc python-lockfile-doc python-nacl-doc python3-gssapi
  python3-invoke
The following NEW packages will be installed:
  duplicity librsync2 python3-fasteners python3-future python3-lockfile
  python3-monotonic python3-nacl python3-paramiko
0 upgraded, 8 newly installed, 0 to remove and 133 not upgraded.
changed: [andriikuiava-2]

RUNNING HANDLER [init : Restart rsyslog] ***************************************
[WARNING]: Could not match supplied host pattern, ignoring: children
changed: [andriikuiava-2]
changed: [andriikuiava-1]
changed: [andriikuiava-3]

PLAY [DNS Servers] *************************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]
ok: [andriikuiava-3]

TASK [bind : Install Bind9] ****************************************************
The following additional packages will be installed:
  bind9-dnsutils bind9-host bind9-libs bind9-utils dns-root-data
  python3-requests-toolbelt
Suggested packages:
  bind-doc resolvconf python3-sniffio python3-trio
The following NEW packages will be installed:
  bind9 bind9-utils dns-root-data python3-dnspython python3-requests-toolbelt
The following packages will be upgraded:
  bind9-dnsutils bind9-host bind9-libs
3 upgraded, 5 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-1]
The following additional packages will be installed:
  bind9-dnsutils bind9-host bind9-libs bind9-utils dns-root-data
  python3-requests-toolbelt
Suggested packages:
  bind-doc resolvconf python3-sniffio python3-trio
The following NEW packages will be installed:
  bind9 bind9-utils dns-root-data python3-dnspython python3-requests-toolbelt
The following packages will be upgraded:
  bind9-dnsutils bind9-host bind9-libs
3 upgraded, 5 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-3]
The following additional packages will be installed:
  bind9-dnsutils bind9-host bind9-libs bind9-utils dns-root-data
  python3-requests-toolbelt
Suggested packages:
  bind-doc resolvconf python3-sniffio python3-trio
The following NEW packages will be installed:
  bind9 bind9-utils dns-root-data python3-dnspython python3-requests-toolbelt
The following packages will be upgraded:
  bind9-dnsutils bind9-host bind9-libs
3 upgraded, 5 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-2]

TASK [bind : Configure DNS forwarders] *****************************************
changed: [andriikuiava-3]
changed: [andriikuiava-1]
changed: [andriikuiava-2]

TASK [bind : Create master zone file] ******************************************
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpfi0iaw0q/db.megacoolproject.j2
@@ -0,0 +1,17 @@
+$TTL 604800
+@   IN  SOA ns.megacoolproject.io. admin.megacoolproject.io. (
+            2          ; Serial
+        604800         ; Refresh
+         86400         ; Retry
+       2419200         ; Expire
+        604800 )       ; Negative Cache TTL
+
+megacoolproject.io. IN NS andriikuiava-3.megacoolproject.io.
+megacoolproject.io. IN NS andriikuiava-1.megacoolproject.io.
+megacoolproject.io. IN NS andriikuiava-2.megacoolproject.io.
+
+andriikuiava-1 IN A 192.168.42.143
+andriikuiava-2 IN A 192.168.42.88
+andriikuiava-3 IN A 192.168.42.146
+
+

changed: [andriikuiava-1]
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpvsob7994/db.megacoolproject.j2
@@ -0,0 +1,17 @@
+$TTL 604800
+@   IN  SOA ns.megacoolproject.io. admin.megacoolproject.io. (
+            2          ; Serial
+        604800         ; Refresh
+         86400         ; Retry
+       2419200         ; Expire
+        604800 )       ; Negative Cache TTL
+
+megacoolproject.io. IN NS andriikuiava-3.megacoolproject.io.
+megacoolproject.io. IN NS andriikuiava-1.megacoolproject.io.
+megacoolproject.io. IN NS andriikuiava-2.megacoolproject.io.
+
+andriikuiava-1 IN A 192.168.42.143
+andriikuiava-2 IN A 192.168.42.88
+andriikuiava-3 IN A 192.168.42.146
+
+

changed: [andriikuiava-3]
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpuyjq43nu/db.megacoolproject.j2
@@ -0,0 +1,17 @@
+$TTL 604800
+@   IN  SOA ns.megacoolproject.io. admin.megacoolproject.io. (
+            2          ; Serial
+        604800         ; Refresh
+         86400         ; Retry
+       2419200         ; Expire
+        604800 )       ; Negative Cache TTL
+
+megacoolproject.io. IN NS andriikuiava-3.megacoolproject.io.
+megacoolproject.io. IN NS andriikuiava-1.megacoolproject.io.
+megacoolproject.io. IN NS andriikuiava-2.megacoolproject.io.
+
+andriikuiava-1 IN A 192.168.42.143
+andriikuiava-2 IN A 192.168.42.88
+andriikuiava-3 IN A 192.168.42.146
+
+

changed: [andriikuiava-2]

TASK [bind : Create reverse zone file] *****************************************
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmp816f9nl7/db.reverse.j2
@@ -0,0 +1,23 @@
+$TTL 604800
+168.192.in-addr.arpa. IN SOA megacoolproject.io. andriikuiava-2.megacoolproject.io. (
+         2  ; Serial
+    604800  ; Refresh
+     86400  ; Retry
+   2419200  ; Expire
+    604800 ) ; Negative Cache TTL
+;
+
+
+168.192.in-addr.arpa. IN NS andriikuiava-1.megacoolproject.io.
+168.192.in-addr.arpa. IN NS andriikuiava-2.megacoolproject.io.
+168.192.in-addr.arpa. IN NS andriikuiava-3.megacoolproject.io.
+
+
+146.42 IN PTR andriikuiava-3.megacoolproject.io.
+
+
+143.42 IN PTR andriikuiava-1.megacoolproject.io.
+
+
+88.42 IN PTR andriikuiava-2.megacoolproject.io.
+

changed: [andriikuiava-3]
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpwmk9ea1z/db.reverse.j2
@@ -0,0 +1,23 @@
+$TTL 604800
+168.192.in-addr.arpa. IN SOA megacoolproject.io. andriikuiava-2.megacoolproject.io. (
+         2  ; Serial
+    604800  ; Refresh
+     86400  ; Retry
+   2419200  ; Expire
+    604800 ) ; Negative Cache TTL
+;
+
+
+168.192.in-addr.arpa. IN NS andriikuiava-1.megacoolproject.io.
+168.192.in-addr.arpa. IN NS andriikuiava-2.megacoolproject.io.
+168.192.in-addr.arpa. IN NS andriikuiava-3.megacoolproject.io.
+
+
+146.42 IN PTR andriikuiava-3.megacoolproject.io.
+
+
+143.42 IN PTR andriikuiava-1.megacoolproject.io.
+
+
+88.42 IN PTR andriikuiava-2.megacoolproject.io.
+

changed: [andriikuiava-2]
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpli79n3h0/db.reverse.j2
@@ -0,0 +1,23 @@
+$TTL 604800
+168.192.in-addr.arpa. IN SOA megacoolproject.io. andriikuiava-2.megacoolproject.io. (
+         2  ; Serial
+    604800  ; Refresh
+     86400  ; Retry
+   2419200  ; Expire
+    604800 ) ; Negative Cache TTL
+;
+
+
+168.192.in-addr.arpa. IN NS andriikuiava-1.megacoolproject.io.
+168.192.in-addr.arpa. IN NS andriikuiava-2.megacoolproject.io.
+168.192.in-addr.arpa. IN NS andriikuiava-3.megacoolproject.io.
+
+
+146.42 IN PTR andriikuiava-3.megacoolproject.io.
+
+
+143.42 IN PTR andriikuiava-1.megacoolproject.io.
+
+
+88.42 IN PTR andriikuiava-2.megacoolproject.io.
+

changed: [andriikuiava-1]

TASK [bind : Configure Bind9 zones] ********************************************
--- before: /etc/bind/named.conf.local
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmp7jgvmspr/named.conf.local.j2
@@ -1,8 +1,40 @@
-//
-// Do any local configuration here
-//
+zone "megacoolproject.io" {

-// Consider adding the 1918 zones here, if they are not used in your
-// organization
-//include "/etc/bind/zones.rfc1918";
+
+  type master;

+  allow-update { key nsupdate.key; };
+
+  allow-transfer {
+    127.0.0.1;
+    key transfer.key;
+        192.168.42.143;
+        192.168.42.88;
+        };
+
+    file "/var/cache/bind/db.megacoolproject.io";
+
+};
+
+zone "168.192.in-addr.arpa." {
+
+
+  type primary;
+
+  allow-update {
+    127.0.0.1;
+    key nsupdate.key;
+        192.168.42.143;
+        192.168.42.88;
+        };
+
+  allow-transfer {
+    127.0.0.1;
+    key transfer.key;
+        192.168.42.143;
+        192.168.42.88;
+        };
+
+    file "/var/cache/bind/db.reverse";
+
+};
\ No newline at end of file

changed: [andriikuiava-3]
--- before: /etc/bind/named.conf.local
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpohvfx1ud/named.conf.local.j2
@@ -1,8 +1,25 @@
-//
-// Do any local configuration here
-//
+zone "megacoolproject.io" {

-// Consider adding the 1918 zones here, if they are not used in your
-// organization
-//include "/etc/bind/zones.rfc1918";
+
+  type slave;

+  masters {
+        192.168.42.146;
+      };
+
+    file "/var/cache/bind/db.megacoolproject.io";
+
+};
+
+zone "168.192.in-addr.arpa." {
+
+
+  type secondary;
+
+  masters {
+        192.168.42.146;
+      };
+
+    file "/var/cache/bind/db.reverse";
+
+};
\ No newline at end of file

changed: [andriikuiava-1]
--- before: /etc/bind/named.conf.local
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpl0ghwkkq/named.conf.local.j2
@@ -1,8 +1,25 @@
-//
-// Do any local configuration here
-//
+zone "megacoolproject.io" {

-// Consider adding the 1918 zones here, if they are not used in your
-// organization
-//include "/etc/bind/zones.rfc1918";
+
+  type slave;

+  masters {
+        192.168.42.146;
+      };
+
+    file "/var/cache/bind/db.megacoolproject.io";
+
+};
+
+zone "168.192.in-addr.arpa." {
+
+
+  type secondary;
+
+  masters {
+        192.168.42.146;
+      };
+
+    file "/var/cache/bind/db.reverse";
+
+};
\ No newline at end of file

changed: [andriikuiava-2]

TASK [bind : Run handlers] *****************************************************

TASK [bind : Run handlers] *****************************************************

TASK [bind : Run handlers] *****************************************************

RUNNING HANDLER [bind : Restart Bind9] *****************************************
changed: [andriikuiava-3]
changed: [andriikuiava-2]
changed: [andriikuiava-1]

RUNNING HANDLER [bind : Reload Bind9] ******************************************
changed: [andriikuiava-2]
changed: [andriikuiava-1]
changed: [andriikuiava-3]

TASK [bind : Ensure Bind9 is running and enabled on boot] **********************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [bind : Download Bind9 exporter] ******************************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]
changed: [andriikuiava-3]

TASK [bind : Unarchive Bind9 exporter] *****************************************
changed: [andriikuiava-3]
changed: [andriikuiava-1]
changed: [andriikuiava-2]

TASK [bind : Create symlink for Bind9 exporter] ********************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/usr/local/bin/prometheus-bind-exporter",
-    "state": "absent"
+    "state": "link"
 }

changed: [andriikuiava-3]
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/usr/local/bin/prometheus-bind-exporter",
-    "state": "absent"
+    "state": "link"
 }

changed: [andriikuiava-1]
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/usr/local/bin/prometheus-bind-exporter",
-    "state": "absent"
+    "state": "link"
 }

changed: [andriikuiava-2]

TASK [bind : Create systemd service for Bind9 exporter] ************************
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpxdq42bro/bind_exporter.service.j2
@@ -0,0 +1,10 @@
+[Unit]
+Description=Prometheus Bind9 Exporter
+After=network.target
+
+[Service]
+ExecStart=/usr/local/bin/prometheus-bind-exporter
+User=bind
+
+[Install]
+WantedBy=multi-user.target
\ No newline at end of file

changed: [andriikuiava-3]
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpvdl67aex/bind_exporter.service.j2
@@ -0,0 +1,10 @@
+[Unit]
+Description=Prometheus Bind9 Exporter
+After=network.target
+
+[Service]
+ExecStart=/usr/local/bin/prometheus-bind-exporter
+User=bind
+
+[Install]
+WantedBy=multi-user.target
\ No newline at end of file

changed: [andriikuiava-2]
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpfhvu3ix8/bind_exporter.service.j2
@@ -0,0 +1,10 @@
+[Unit]
+Description=Prometheus Bind9 Exporter
+After=network.target
+
+[Service]
+ExecStart=/usr/local/bin/prometheus-bind-exporter
+User=bind
+
+[Install]
+WantedBy=multi-user.target
\ No newline at end of file

changed: [andriikuiava-1]

TASK [bind : Reload systemd] ***************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [bind : Start Bind9 exporter service] *************************************
changed: [andriikuiava-1]
changed: [andriikuiava-3]
changed: [andriikuiava-2]

TASK [bind : Add A record for backup server] ***********************************
changed: [andriikuiava-2]
ok: [andriikuiava-1]
ok: [andriikuiava-3]

TASK [bind : Add CNAME for Bind9 servers] **************************************
changed: [andriikuiava-3] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2] => (item=None)
changed: [andriikuiava-1] => (item=None)
ok: [andriikuiava-3] => (item=None)
ok: [andriikuiava-2] => (item=None)
changed: [andriikuiava-3] => (item=None)
changed: [andriikuiava-2] => (item=None)
changed: [andriikuiava-1] => (item=None)
changed: [andriikuiava-3]
changed: [andriikuiava-2]
changed: [andriikuiava-1]

RUNNING HANDLER [bind : Restart Bind9] *****************************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]
changed: [andriikuiava-3]

RUNNING HANDLER [bind : Reload Systemd] ****************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

PLAY [Resolv DNS] **************************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [resolv_dns : Disable systemd-resolved] ***********************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]
changed: [andriikuiava-3]

TASK [resolv_dns : Create resolv.conf with DNS settings] ***********************
--- before: /etc/resolv.conf
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmp3kwisfov/resolv.conf.j2
@@ -1,23 +1,3 @@
-# This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).
-# Do not edit.
-#
-# This file might be symlinked as /etc/resolv.conf. If you're looking at
-# /etc/resolv.conf and seeing this text, you have followed the symlink.
-#
-# This is a dynamic resolv.conf file for connecting local clients to the
-# internal DNS stub resolver of systemd-resolved. This file lists all
-# configured search domains.
-#
-# Run "resolvectl status" to see details about the uplink DNS servers
-# currently in use.
-#
-# Third party programs should typically not access this file directly, but only
-# through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a
-# different way, replace this symlink by a static file or a different symlink.
-#
-# See man:systemd-resolved.service(8) for details about the supported modes of
-# operation for /etc/resolv.conf.
-
-nameserver 127.0.0.53
-options edns0 trust-ad
-search openstacklocal
+search megacoolproject.io
+nameserver 192.168.42.143
+nameserver 192.168.42.88

changed: [andriikuiava-2]
--- before: /etc/resolv.conf
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpfsk03enw/resolv.conf.j2
@@ -1,23 +1,3 @@
-# This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).
-# Do not edit.
-#
-# This file might be symlinked as /etc/resolv.conf. If you're looking at
-# /etc/resolv.conf and seeing this text, you have followed the symlink.
-#
-# This is a dynamic resolv.conf file for connecting local clients to the
-# internal DNS stub resolver of systemd-resolved. This file lists all
-# configured search domains.
-#
-# Run "resolvectl status" to see details about the uplink DNS servers
-# currently in use.
-#
-# Third party programs should typically not access this file directly, but only
-# through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a
-# different way, replace this symlink by a static file or a different symlink.
-#
-# See man:systemd-resolved.service(8) for details about the supported modes of
-# operation for /etc/resolv.conf.
-
-nameserver 127.0.0.53
-options edns0 trust-ad
-search openstacklocal
+search megacoolproject.io
+nameserver 192.168.42.143
+nameserver 192.168.42.88

changed: [andriikuiava-3]
--- before: /etc/resolv.conf
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmppxwuhwn4/resolv.conf.j2
@@ -1,23 +1,3 @@
-# This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).
-# Do not edit.
-#
-# This file might be symlinked as /etc/resolv.conf. If you're looking at
-# /etc/resolv.conf and seeing this text, you have followed the symlink.
-#
-# This is a dynamic resolv.conf file for connecting local clients to the
-# internal DNS stub resolver of systemd-resolved. This file lists all
-# configured search domains.
-#
-# Run "resolvectl status" to see details about the uplink DNS servers
-# currently in use.
-#
-# Third party programs should typically not access this file directly, but only
-# through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a
-# different way, replace this symlink by a static file or a different symlink.
-#
-# See man:systemd-resolved.service(8) for details about the supported modes of
-# operation for /etc/resolv.conf.
-
-nameserver 127.0.0.53
-options edns0 trust-ad
-search openstacklocal
+search megacoolproject.io
+nameserver 192.168.42.143
+nameserver 192.168.42.88

changed: [andriikuiava-1]

PLAY [Database Server] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Install MySQL server] ********************************************
The following additional packages will be installed:
  libcgi-fast-perl libcgi-pm-perl libclone-perl libencode-locale-perl
  libevent-pthreads-2.1-7 libfcgi-bin libfcgi-perl libfcgi0ldbl
  libhtml-parser-perl libhtml-tagset-perl libhtml-template-perl
  libhttp-date-perl libhttp-message-perl libio-html-perl
  liblwp-mediatypes-perl libmecab2 libprotobuf-lite23 liburi-perl mecab-ipadic
  mecab-ipadic-utf8 mecab-utils mysql-client-8.0 mysql-client-core-8.0
  mysql-common mysql-server-8.0 mysql-server-core-8.0
Suggested packages:
  libdata-dump-perl libipc-sharedcache-perl libbusiness-isbn-perl libwww-perl
  mailx tinyca
The following NEW packages will be installed:
  libcgi-fast-perl libcgi-pm-perl libclone-perl libencode-locale-perl
  libevent-pthreads-2.1-7 libfcgi-bin libfcgi-perl libfcgi0ldbl
  libhtml-parser-perl libhtml-tagset-perl libhtml-template-perl
  libhttp-date-perl libhttp-message-perl libio-html-perl
  liblwp-mediatypes-perl libmecab2 libprotobuf-lite23 liburi-perl mecab-ipadic
  mecab-ipadic-utf8 mecab-utils mysql-client-8.0 mysql-client-core-8.0
  mysql-common mysql-server mysql-server-8.0 mysql-server-core-8.0
0 upgraded, 27 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-1]
The following additional packages will be installed:
  libcgi-fast-perl libcgi-pm-perl libclone-perl libencode-locale-perl
  libevent-pthreads-2.1-7 libfcgi-bin libfcgi-perl libfcgi0ldbl
  libhtml-parser-perl libhtml-tagset-perl libhtml-template-perl
  libhttp-date-perl libhttp-message-perl libio-html-perl
  liblwp-mediatypes-perl libmecab2 libprotobuf-lite23 liburi-perl mecab-ipadic
  mecab-ipadic-utf8 mecab-utils mysql-client-8.0 mysql-client-core-8.0
  mysql-common mysql-server-8.0 mysql-server-core-8.0
Suggested packages:
  libdata-dump-perl libipc-sharedcache-perl libbusiness-isbn-perl libwww-perl
  mailx tinyca
The following NEW packages will be installed:
  libcgi-fast-perl libcgi-pm-perl libclone-perl libencode-locale-perl
  libevent-pthreads-2.1-7 libfcgi-bin libfcgi-perl libfcgi0ldbl
  libhtml-parser-perl libhtml-tagset-perl libhtml-template-perl
  libhttp-date-perl libhttp-message-perl libio-html-perl
  liblwp-mediatypes-perl libmecab2 libprotobuf-lite23 liburi-perl mecab-ipadic
  mecab-ipadic-utf8 mecab-utils mysql-client-8.0 mysql-client-core-8.0
  mysql-common mysql-server mysql-server-8.0 mysql-server-core-8.0
0 upgraded, 27 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-2]

TASK [mysql : Install PyMySQL] *************************************************
Suggested packages:
  python-pymysql-doc
The following NEW packages will be installed:
  python3-pymysql
0 upgraded, 1 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-1]
Suggested packages:
  python-pymysql-doc
The following NEW packages will be installed:
  python3-pymysql
0 upgraded, 1 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-2]

TASK [mysql : Ensure MySQL service is running] *********************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Wait for MySQL to be ready] **************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Create MySQL override configuration] *****************************
--- before
+++ after: /etc/mysql/mysql.conf.d/override.cnf
@@ -0,0 +1,6 @@
+[mysqld]
+bind-address = 0.0.0.0
+log-bin = /var/log/mysql/mysql-bin.log
+relay-log = /var/log/mysql/mysql-relay.log
+replicate-do-db = agama
+server-id = 143

changed: [andriikuiava-1]
--- before
+++ after: /etc/mysql/mysql.conf.d/override.cnf
@@ -0,0 +1,6 @@
+[mysqld]
+bind-address = 0.0.0.0
+log-bin = /var/log/mysql/mysql-bin.log
+relay-log = /var/log/mysql/mysql-relay.log
+replicate-do-db = agama
+server-id = 88

changed: [andriikuiava-2]

TASK [mysql : MySQL database] **************************************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]

TASK [mysql : MySQL user] ******************************************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]

TASK [mysql : Install MySQL exporter] ******************************************
The following NEW packages will be installed:
  prometheus-mysqld-exporter
0 upgraded, 1 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-2]
The following NEW packages will be installed:
  prometheus-mysqld-exporter
0 upgraded, 1 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-1]

TASK [mysql : Create MySQL user for exporter] **********************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]

TASK [mysql : Configure MySQL exporter credentials] ****************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]

TASK [mysql : Ensure /home/backup/mysql directory exists] **********************
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/mysql",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-1]
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/mysql",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-2]

TASK [mysql : Create MySQL backup user] ****************************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]

TASK [mysql : Create MySQL client configuration file for backup user] **********
changed: [andriikuiava-2]
changed: [andriikuiava-1]

TASK [mysql : Ensure /home/backup/mysql directory exists] **********************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Create Cron job for MySQL backups] *******************************
--- before
+++ after: /etc/cron.d/mysql-backup
@@ -0,0 +1 @@
+

changed: [andriikuiava-1]
--- before
+++ after: /etc/cron.d/mysql-backup
@@ -0,0 +1,4 @@
+PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
+12 0 * * * backup mysqldump agama > /home/backup/mysql/agama.sql
+12 0 * * 0  backup  duplicity --no-encryption full /home/backup/mysql/ rsync://andriikuiava@backup.megacoolproject.io/mysql
+12 0 * * 1-6  backup  duplicity --no-encryption incremental /home/backup/mysql/ rsync://andriikuiava@backup.megacoolproject.io/mysql

changed: [andriikuiava-2]

TASK [mysql : Create MySQL replication user] ***********************************
changed: [andriikuiava-2]
changed: [andriikuiava-1]

TASK [mysql : Set MySQL read_only mode dynamically] ****************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]

TASK [mysql : Add CNAME for MySQL instances] ***********************************
changed: [andriikuiava-2] => (item=None)
changed: [andriikuiava-1] => (item=None)
changed: [andriikuiava-2] => (item=None)
changed: [andriikuiava-1] => (item=None)
changed: [andriikuiava-2]
changed: [andriikuiava-1]

RUNNING HANDLER [mysql : Restart MySQL] ****************************************
changed: [andriikuiava-2]
changed: [andriikuiava-1]

RUNNING HANDLER [mysql : Restart MySQL Exporter] *******************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]

RUNNING HANDLER [mysql : Restart Cron] *****************************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]

RUNNING HANDLER [mysql : Reset MySQL source] ***********************************
skipping: [andriikuiava-2] => (item=stopreplica)
skipping: [andriikuiava-2] => (item=resetprimary)
skipping: [andriikuiava-2]
changed: [andriikuiava-1] => (item=stopreplica)
changed: [andriikuiava-1] => (item=resetprimary)

RUNNING HANDLER [mysql : Reset MySQL replica] **********************************
skipping: [andriikuiava-1] => (item=None)
skipping: [andriikuiava-1] => (item=None)
skipping: [andriikuiava-1] => (item=None)
skipping: [andriikuiava-1] => (item=None)
skipping: [andriikuiava-1]
changed: [andriikuiava-2] => (item=None)
changed: [andriikuiava-2] => (item=None)
changed: [andriikuiava-2] => (item=None)
changed: [andriikuiava-2] => (item=None)
changed: [andriikuiava-2]

PLAY [Prometheus Servers] ******************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]

TASK [prometheus : Install Prometheus] *****************************************
The following additional packages will be installed:
  fonts-glyphicons-halflings javascript-common libjs-bootstrap
  libjs-bootstrap4 libjs-d3 libjs-eonasdan-bootstrap-datetimepicker
  libjs-jquery libjs-jquery-hotkeys libjs-moment libjs-moment-timezone
  libjs-mustache libjs-popper.js libjs-rickshaw libjs-sizzle node-jquery
Suggested packages:
  apache2 | lighttpd | httpd
The following NEW packages will be installed:
  fonts-glyphicons-halflings javascript-common libjs-bootstrap
  libjs-bootstrap4 libjs-d3 libjs-eonasdan-bootstrap-datetimepicker
  libjs-jquery libjs-jquery-hotkeys libjs-moment libjs-moment-timezone
  libjs-mustache libjs-popper.js libjs-rickshaw libjs-sizzle node-jquery
  prometheus
0 upgraded, 16 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-3]

TASK [prometheus : Configure Prometheus Service] *******************************
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmp5375b2dw/prometheus.service
@@ -0,0 +1,18 @@
+[Unit]
+Description=Prometheus
+Wants=network-online.target
+After=network-online.target
+
+[Service]
+User=prometheus
+Group=prometheus
+Type=simple
+ExecStart=/usr/bin/prometheus \
+    --config.file /etc/prometheus/prometheus.yml \
+    --storage.tsdb.path /var/lib/prometheus/ \
+    --web.console.templates=/etc/prometheus/consoles \
+    --web.console.libraries=/etc/prometheus/console_libraries \
+    --web.external-url=http://193.40.156.67:1380/prometheus
+
+[Install]
+WantedBy=multi-user.target

changed: [andriikuiava-3]

TASK [prometheus : Configure Prometheus] ***************************************
--- before: /etc/prometheus/prometheus.yml
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpza0mcfhp/prometheus.yml.j2
@@ -1,44 +1,54 @@
-# Sample config for Prometheus.
+global:
+  scrape_interval: 15s

-global:
-  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.
-  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.
-  # scrape_timeout is set to the global default (10s).
-
-  # Attach these labels to any time series or alerts when communicating with
-  # external systems (federation, remote storage, Alertmanager).
-  external_labels:
-      monitor: 'example'
-
-# Alertmanager configuration
-alerting:
-  alertmanagers:
-  - static_configs:
-    - targets: ['localhost:9093']
-
-# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
-rule_files:
-  # - "first_rules.yml"
-  # - "second_rules.yml"
-
-# A scrape configuration containing exactly one endpoint to scrape:
-# Here it's Prometheus itself.
 scrape_configs:
-  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
+  # Scrape Prometheus itself
   - job_name: 'prometheus'
-
-    # Override the global default and scrape targets from this job every 5 seconds.
-    scrape_interval: 5s
-    scrape_timeout: 5s
-
-    # metrics_path defaults to '/metrics'
-    # scheme defaults to 'http'.
-
     static_configs:
       - targets: ['localhost:9090']
+    metrics_path: '/prometheus/metrics'

-  - job_name: node
-    # If prometheus-node-exporter is installed, grab stats about the local
-    # machine by default.
+  - job_name: 'backup_metrics'
     static_configs:
-      - targets: ['localhost:9100']
+      - targets: [backup.megacoolproject.io:9111]
+
+  # Scrape all VMs
+  - job_name: 'linux'
+    static_configs:
+      - targets:
+          - 'andriikuiava-1:9100'
+          - 'andriikuiava-2:9100'
+          - 'andriikuiava-3:9100'
+
+# Bind9 Exporter
+  - job_name: 'bind9'
+    static_configs:
+      - targets: ['ns-1.megacoolproject.io:9119', 'ns-2.megacoolproject.io:9119']
+
+# MySQL Exporter
+  - job_name: 'mysql'
+    static_configs:
+      - targets: [db-1.megacoolproject.io:9104, db-2.megacoolproject.io:9104]
+
+# Nginx Exporter
+  - job_name: 'nginx'
+    static_configs:
+      - targets:
+        - andriikuiava-1:9113
+        - andriikuiava-2:9113
+        - andriikuiava-3:9113
+
+# HAProxy Exporter
+  - job_name: 'haproxy'
+    static_configs:
+      - targets: ['lb-1.megacoolproject.io:9101', 'lb-2.megacoolproject.io:9101']
+
+# Influx Exporter
+  - job_name: 'influxdb'
+    static_configs:
+      - targets: ['influxdb.megacoolproject.io:9424']
+
+# Keepalived Exporter
+  - job_name: 'keepalived'
+    static_configs:
+      - targets: ['andriikuiava-1:9165', 'andriikuiava-2:9165']
\ No newline at end of file

changed: [andriikuiava-3]

TASK [prometheus : Run Prometheus] *********************************************
ok: [andriikuiava-3]

TASK [prometheus : Install Nginx] **********************************************
The following additional packages will be installed:
  fontconfig-config fonts-dejavu-core libdeflate0 libfontconfig1 libgd3
  libjbig0 libjpeg-turbo8 libjpeg8 libnginx-mod-http-geoip2
  libnginx-mod-http-image-filter libnginx-mod-http-xslt-filter
  libnginx-mod-mail libnginx-mod-stream libnginx-mod-stream-geoip2 libtiff5
  libwebp7 libxpm4 nginx-common nginx-core
Suggested packages:
  libgd-tools fcgiwrap nginx-doc ssl-cert
The following NEW packages will be installed:
  fontconfig-config fonts-dejavu-core libdeflate0 libfontconfig1 libgd3
  libjbig0 libjpeg-turbo8 libjpeg8 libnginx-mod-http-geoip2
  libnginx-mod-http-image-filter libnginx-mod-http-xslt-filter
  libnginx-mod-mail libnginx-mod-stream libnginx-mod-stream-geoip2 libtiff5
  libwebp7 libxpm4 nginx nginx-common nginx-core
0 upgraded, 20 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-3]

TASK [prometheus : Start Nginx] ************************************************
ok: [andriikuiava-3]

TASK [prometheus : Add CNAME for Prometheus] ***********************************
changed: [andriikuiava-3]

RUNNING HANDLER [prometheus : Stop Prometheus] *********************************
changed: [andriikuiava-3]

RUNNING HANDLER [prometheus : Start Prometheus] ********************************
changed: [andriikuiava-3]

RUNNING HANDLER [prometheus : Daemon Reload] ***********************************
ok: [andriikuiava-3]

PLAY [Docker] ******************************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [docker : Install Docker.io package] **************************************
The following additional packages will be installed:
  bridge-utils containerd dnsmasq-base pigz runc ubuntu-fan
Suggested packages:
  ifupdown aufs-tools cgroupfs-mount | cgroup-lite debootstrap docker-doc
  rinse zfs-fuse | zfsutils
The following NEW packages will be installed:
  bridge-utils containerd dnsmasq-base docker.io pigz runc ubuntu-fan
0 upgraded, 7 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-3]
The following additional packages will be installed:
  bridge-utils containerd dnsmasq-base pigz runc ubuntu-fan
Suggested packages:
  ifupdown aufs-tools cgroupfs-mount | cgroup-lite debootstrap docker-doc
  rinse zfs-fuse | zfsutils
The following NEW packages will be installed:
  bridge-utils containerd dnsmasq-base docker.io pigz runc ubuntu-fan
0 upgraded, 7 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-2]
The following additional packages will be installed:
  bridge-utils containerd dnsmasq-base pigz runc ubuntu-fan
Suggested packages:
  ifupdown aufs-tools cgroupfs-mount | cgroup-lite debootstrap docker-doc
  rinse zfs-fuse | zfsutils
The following NEW packages will be installed:
  bridge-utils containerd dnsmasq-base docker.io pigz runc ubuntu-fan
0 upgraded, 7 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-1]

TASK [docker : Install python3-docker package] *********************************
The following additional packages will be installed:
  python3-websocket
The following NEW packages will be installed:
  python3-docker python3-websocket
0 upgraded, 2 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-1]
The following additional packages will be installed:
  python3-websocket
The following NEW packages will be installed:
  python3-docker python3-websocket
0 upgraded, 2 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-2]
The following additional packages will be installed:
  python3-websocket
The following NEW packages will be installed:
  python3-docker python3-websocket
0 upgraded, 2 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-3]

TASK [docker : Ensure Docker daemon is running and enabled] ********************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

PLAY [Grafana Tasks] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]

TASK [grafana : Create required directories for Grafana provisioning] **********
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/opt/grafana/provisioning/dashboards",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-3] => (item=dashboards)
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/opt/grafana/provisioning/datasources",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-3] => (item=datasources)

TASK [grafana : Copy grafana.ini configuration] ********************************
changed: [andriikuiava-3]

TASK [grafana : Copy dashboard provisioning configuration] *********************
--- before
+++ after: /Users/andriikuiava/IdeaProjects/ica0002/roles/grafana/files/dashboards.yaml
@@ -0,0 +1,11 @@
+apiVersion: 1
+
+providers:
+  - name: "Main Dashboard"
+    orgId: 1
+    folder: ""
+    type: file
+    disableDeletion: false
+    editable: true
+    options:
+      path: /etc/grafana/provisioning/dashboards

changed: [andriikuiava-3]

TASK [grafana : Copy datasource provisioning configuration] ********************
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpo7tsk2gr/datasource.yaml.j2
@@ -0,0 +1,20 @@
+apiVersion: 1
+datasources:
+  - name: Prometheus
+    type: prometheus
+    url: http://prometheus.megacoolproject.io:9090/prometheus
+    access: proxy
+    isDefault: true
+
+  - name: AgamaDB
+    type: influxdb
+    url:  http://influxdb.megacoolproject.io:8086
+    access: proxy
+    database: example
+
+  - name: InfluxDB:Telegraf
+    type: influxdb
+    access: proxy
+    url: http://influxdb.megacoolproject.io:8086
+    jsonData:
+      dbName: syslog
\ No newline at end of file

changed: [andriikuiava-3]

TASK [grafana : Copy dashboards JSON files] ************************************
--- before
+++ after: /Users/andriikuiava/IdeaProjects/ica0002/roles/grafana/files/backups.json
@@ -0,0 +1,395 @@
+{
+  "annotations": {
+    "list": [
+      {
+        "builtIn": 1,
+        "datasource": {
+          "type": "grafana",
+          "uid": "-- Grafana --"
+        },
+        "enable": true,
+        "hide": true,
+        "iconColor": "rgba(0, 211, 255, 1)",
+        "name": "Annotations & Alerts",
+        "type": "dashboard"
+      }
+    ]
+  },
+  "editable": true,
+  "fiscalYearStartMonth": 0,
+  "graphTooltip": 0,
+  "id": 1,
+  "links": [],
+  "panels": [
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 0
+      },
+      "id": 6,
+      "options": {
+        "minVizHeight": 75,
+        "minVizWidth": 75,
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showThresholdLabels": false,
+        "showThresholdMarkers": true,
+        "sizing": "auto"
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "sum(backups_total{service=\"influxdb\", type=\"incremental\"}) by (service, type)",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Incremental Backups influxdb",
+      "type": "gauge"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 12,
+        "y": 0
+      },
+      "id": 5,
+      "options": {
+        "minVizHeight": 75,
+        "minVizWidth": 75,
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showThresholdLabels": false,
+        "showThresholdMarkers": true,
+        "sizing": "auto"
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "sum(backups_total{service=\"mysql\", type=\"incremental\"}) by (service, type)",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Incremental Backups mysql",
+      "type": "gauge"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 8
+      },
+      "id": 3,
+      "options": {
+        "minVizHeight": 75,
+        "minVizWidth": 75,
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showThresholdLabels": false,
+        "showThresholdMarkers": true,
+        "sizing": "auto"
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "time() - backup_last_success_time{service=\"mysql\", user = \"andriikuiava\"}",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Last Backup Success Time mysql",
+      "type": "gauge"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 12,
+        "y": 8
+      },
+      "id": 4,
+      "options": {
+        "minVizHeight": 75,
+        "minVizWidth": 75,
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showThresholdLabels": false,
+        "showThresholdMarkers": true,
+        "sizing": "auto"
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "time() - backup_last_success_time{service=\"influxdb\", user = \"andriikuiava\"}",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Last Backup Success Time influxdb",
+      "type": "gauge"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "min": 0,
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 16
+      },
+      "id": 2,
+      "options": {
+        "minVizHeight": 75,
+        "minVizWidth": 75,
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showThresholdLabels": false,
+        "showThresholdMarkers": true,
+        "sizing": "auto"
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "sum(backups_total{service=\"influxdb\", type=\"full\"}) by (service, type)",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "InfluxDB full backups",
+      "type": "gauge"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "min": -12,
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 12,
+        "y": 16
+      },
+      "id": 1,
+      "options": {
+        "minVizHeight": 75,
+        "minVizWidth": 75,
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showThresholdLabels": false,
+        "showThresholdMarkers": true,
+        "sizing": "auto"
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "editorMode": "code",
+          "expr": "sum(backups_total{service=\"mysql\", type=\"full\"}) by (service, type)",
+          "legendFormat": "{{service}} {{type}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Full mysql backups",
+      "type": "gauge"
+    }
+  ],
+  "preload": false,
+  "schemaVersion": 40,
+  "tags": [],
+  "templating": {
+    "list": []
+  },
+  "time": {
+    "from": "now-6h",
+    "to": "now"
+  },
+  "timepicker": {},
+  "timezone": "browser",
+  "title": "Backups",
+  "uid": "fe6b8rrg701s0c",
+  "version": 1,
+  "weekStart": ""
+}
\ No newline at end of file

changed: [andriikuiava-3] => (item=backups.json)
--- before
+++ after: /Users/andriikuiava/IdeaProjects/ica0002/roles/grafana/files/main.json
@@ -0,0 +1,1075 @@
+{
+  "annotations": {
+    "list": [
+      {
+        "builtIn": 1,
+        "datasource": {
+          "type": "grafana",
+          "uid": "-- Grafana --"
+        },
+        "enable": true,
+        "hide": true,
+        "iconColor": "rgba(0, 211, 255, 1)",
+        "name": "Annotations & Alerts",
+        "type": "dashboard"
+      }
+    ]
+  },
+  "editable": true,
+  "fiscalYearStartMonth": 0,
+  "graphTooltip": 0,
+  "id": null,
+  "links": [],
+  "panels": [
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 0
+      },
+      "id": 2,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "influxdb_write_write_ok",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "InfluxDB write rate",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 12,
+        "y": 0
+      },
+      "id": 9,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Memory consumption on VMs",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "influxdb",
+        "uid": "P232F78820213A885"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 8
+      },
+      "id": 6,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "datasource": {
+            "type": "influxdb",
+            "uid": "P232F78820213A885"
+          },
+          "query": "SELECT LAST(\"items\") FROM \"agama-stats\"",
+          "rawQuery": true,
+          "refId": "A",
+          "resultFormat": "time_series"
+        }
+      ],
+      "title": "Agama num of items",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 12,
+        "y": 8
+      },
+      "id": 4,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "rate(mysql_global_status_commands_total{command=\"select\"}[1m])",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "MySQL status + amount of selects per minute (mysql_global_status_commands_total)",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "influxdb",
+        "uid": "P232F78820213A885"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 16
+      },
+      "id": 7,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "datasource": {
+            "type": "influxdb",
+            "uid": "P232F78820213A885"
+          },
+          "query": "SELECT COUNT(\"items\") FROM \"agama-stats\" WHERE $timeFilter GROUP BY time($__interval) fill(null)",
+          "rawQuery": true,
+          "refId": "A",
+          "resultFormat": "time_series"
+        }
+      ],
+      "title": "All Agamas count",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 12,
+        "y": 16
+      },
+      "id": 8,
+      "options": {
+        "minVizHeight": 75,
+        "minVizWidth": 75,
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showThresholdLabels": false,
+        "showThresholdMarkers": true,
+        "sizing": "auto"
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "editorMode": "code",
+          "expr": "avg(rate(node_cpu_seconds_total{mode!=\"idle\"}[1m])) by (instance)",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "CPU utilisation on VMs",
+      "type": "gauge"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 24
+      },
+      "id": 5,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "rate(nginx_http_requests_total[1m])",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Nginx status + amount of requests per minute (nginx_http_requests_total)",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "color": "red",
+                  "index": 1,
+                  "text": "DOWN"
+                },
+                "1": {
+                  "color": "green",
+                  "index": 0,
+                  "text": "UP"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "max": 1,
+          "min": 0,
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 12,
+        "y": 24
+      },
+      "id": 1,
+      "options": {
+        "minVizHeight": 75,
+        "minVizWidth": 75,
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showThresholdLabels": false,
+        "showThresholdMarkers": true,
+        "sizing": "auto"
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "editorMode": "code",
+          "expr": "influxdb_exporter_stats_query_success",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "InfluxDB health",
+      "type": "gauge"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "line",
+            "fillOpacity": 0,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "auto",
+            "spanNulls": false,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 24,
+        "x": 0,
+        "y": 32
+      },
+      "id": 3,
+      "options": {
+        "legend": {
+          "calcs": [],
+          "displayMode": "list",
+          "placement": "bottom",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "single",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "rate(bind_resolver_queries_total[1m])",
+          "legendFormat": "__auto",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "Bind9 status + amount of A DNS queries per minute (bind_resolver_queries_total)",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "color": "red",
+                  "index": 1,
+                  "text": "DOWN"
+                },
+                "1": {
+                  "color": "green",
+                  "index": 0,
+                  "text": "UP"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "max": 1,
+          "min": 0,
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 40
+      },
+      "id": 11,
+      "options": {
+        "minVizHeight": 75,
+        "minVizWidth": 75,
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showThresholdLabels": false,
+        "showThresholdMarkers": true,
+        "sizing": "auto"
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "keepalived_up",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "keepalived_up",
+      "type": "gauge"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "max": 2,
+          "min": 0,
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 12,
+        "y": 40
+      },
+      "id": 12,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "keepalived_vrrp_state",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "keepalived_vrrp_state",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "color": "red",
+                  "index": 0,
+                  "text": "DOWN"
+                },
+                "1": {
+                  "color": "green",
+                  "index": 1,
+                  "text": "UP"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "max": 1,
+          "min": 0,
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 48
+      },
+      "id": 10,
+      "options": {
+        "minVizHeight": 12,
+        "minVizWidth": 75,
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showThresholdLabels": false,
+        "showThresholdMarkers": true,
+        "sizing": "auto"
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "haproxy_up",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "haproxy_up",
+      "type": "gauge"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "max": 1,
+          "min": 0,
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 7,
+        "w": 12,
+        "x": 12,
+        "y": 48
+      },
+      "id": 13,
+      "options": {
+        "minVizHeight": 75,
+        "minVizWidth": 75,
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showThresholdLabels": false,
+        "showThresholdMarkers": true,
+        "sizing": "auto"
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "haproxy_server_up",
+          "legendFormat": "{{server}} - {{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "haproxy_server_up",
+      "type": "gauge"
+    }
+  ],
+  "preload": false,
+  "schemaVersion": 40,
+  "tags": [],
+  "templating": {
+    "list": []
+  },
+  "time": {
+    "from": "now-5m",
+    "to": "now"
+  },
+  "timepicker": {},
+  "timezone": "browser",
+  "title": "Main Dashboard",
+  "uid": "be4wy8vzhdmgwa",
+  "version": 1,
+  "weekStart": ""
+}
\ No newline at end of file

changed: [andriikuiava-3] => (item=main.json)
--- before
+++ after: /Users/andriikuiava/IdeaProjects/ica0002/roles/grafana/files/mysql.json
@@ -0,0 +1,345 @@
+{
+  "annotations": {
+    "list": [
+      {
+        "builtIn": 1,
+        "datasource": {
+          "type": "grafana",
+          "uid": "-- Grafana --"
+        },
+        "enable": true,
+        "hide": true,
+        "iconColor": "rgba(0, 211, 255, 1)",
+        "name": "Annotations & Alerts",
+        "type": "dashboard"
+      }
+    ]
+  },
+  "editable": true,
+  "fiscalYearStartMonth": 0,
+  "graphTooltip": 0,
+  "id": null,
+  "links": [],
+  "panels": [
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "color": "red",
+                  "index": 0,
+                  "text": "DOWN"
+                },
+                "1": {
+                  "color": "green",
+                  "index": 1,
+                  "text": "UP"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "max": 1,
+          "min": 0,
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 0
+      },
+      "id": 4,
+      "options": {
+        "minVizHeight": 75,
+        "minVizWidth": 75,
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showThresholdLabels": false,
+        "showThresholdMarkers": true,
+        "sizing": "auto"
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "mysql_slave_status_slave_io_running",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        },
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "editorMode": "code",
+          "expr": "mysql_slave_status_slave_sql_running",
+          "hide": false,
+          "instant": false,
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "B"
+        }
+      ],
+      "title": "historical data for MySQL replication threads",
+      "type": "gauge"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [
+            {
+              "options": {
+                "0": {
+                  "color": "red",
+                  "index": 0,
+                  "text": "DOWN"
+                },
+                "1": {
+                  "color": "green",
+                  "index": 1,
+                  "text": "UP"
+                }
+              },
+              "type": "value"
+            }
+          ],
+          "max": 1,
+          "min": 0,
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 12,
+        "y": 0
+      },
+      "id": 3,
+      "options": {
+        "minVizHeight": 75,
+        "minVizWidth": 75,
+        "orientation": "auto",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showThresholdLabels": false,
+        "showThresholdMarkers": true,
+        "sizing": "auto"
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "mysql_global_variables_read_only",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "historical data for MySQL server read only status",
+      "type": "gauge"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "fixedColor": "#80808042",
+            "mode": "fixed"
+          },
+          "mappings": [],
+          "max": 10000,
+          "min": 0,
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 0,
+        "y": 8
+      },
+      "id": 2,
+      "options": {
+        "colorMode": "none",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "editorMode": "code",
+          "expr": "mysql_global_variables_server_id",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "MySQL server ids",
+      "type": "stat"
+    },
+    {
+      "datasource": {
+        "type": "prometheus",
+        "uid": "PBFA97CFB590B2093"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          }
+        },
+        "overrides": []
+      },
+      "gridPos": {
+        "h": 8,
+        "w": 12,
+        "x": 12,
+        "y": 8
+      },
+      "id": 1,
+      "options": {
+        "colorMode": "value",
+        "graphMode": "area",
+        "justifyMode": "auto",
+        "orientation": "auto",
+        "percentChangeColorMode": "standard",
+        "reduceOptions": {
+          "calcs": [
+            "lastNotNull"
+          ],
+          "fields": "",
+          "values": false
+        },
+        "showPercentChange": false,
+        "textMode": "auto",
+        "wideLayout": true
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "datasource": {
+            "type": "prometheus",
+            "uid": "PBFA97CFB590B2093"
+          },
+          "editorMode": "code",
+          "expr": "rate(mysql_global_status_commands_total{command=\"select\"}[1m])",
+          "legendFormat": "{{instance}}",
+          "range": true,
+          "refId": "A"
+        }
+      ],
+      "title": "MySQL status + amount of selects per minute (mysql_global_status_commands_total)",
+      "type": "stat"
+    }
+  ],
+  "preload": false,
+  "schemaVersion": 40,
+  "tags": [],
+  "templating": {
+    "list": []
+  },
+  "time": {
+    "from": "now-6h",
+    "to": "now"
+  },
+  "timepicker": {},
+  "timezone": "browser",
+  "title": "MySQL",
+  "uid": "fe6fhmumcgx6od",
+  "version": 1,
+  "weekStart": ""
+}
\ No newline at end of file

changed: [andriikuiava-3] => (item=mysql.json)
--- before
+++ after: /Users/andriikuiava/IdeaProjects/ica0002/roles/grafana/files/syslog.json
@@ -0,0 +1,1118 @@
+{
+  "annotations": {
+    "list": [
+      {
+        "builtIn": 1,
+        "datasource": {
+          "type": "datasource",
+          "uid": "grafana"
+        },
+        "enable": true,
+        "hide": true,
+        "iconColor": "rgba(0, 211, 255, 1)",
+        "name": "Annotations & Alerts",
+        "type": "dashboard"
+      }
+    ]
+  },
+  "description": "Telegraf / InfluxDB / Grafana as syslog receiver",
+  "editable": true,
+  "fiscalYearStartMonth": 0,
+  "graphTooltip": 0,
+  "id": null,
+  "links": [],
+  "panels": [
+    {
+      "datasource": {
+        "type": "influxdb",
+        "uid": "PDD5124384626356D"
+      },
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "palette-classic"
+          },
+          "custom": {
+            "axisBorderShow": false,
+            "axisCenteredZero": false,
+            "axisColorMode": "text",
+            "axisLabel": "Messages / min",
+            "axisPlacement": "auto",
+            "barAlignment": 0,
+            "barWidthFactor": 0.6,
+            "drawStyle": "bars",
+            "fillOpacity": 100,
+            "gradientMode": "none",
+            "hideFrom": {
+              "legend": false,
+              "tooltip": false,
+              "viz": false
+            },
+            "insertNulls": false,
+            "lineInterpolation": "linear",
+            "lineWidth": 1,
+            "pointSize": 5,
+            "scaleDistribution": {
+              "type": "linear"
+            },
+            "showPoints": "never",
+            "spanNulls": true,
+            "stacking": {
+              "group": "A",
+              "mode": "none"
+            },
+            "thresholdsStyle": {
+              "mode": "off"
+            }
+          },
+          "decimals": 0,
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "green",
+                "value": null
+              },
+              {
+                "color": "red",
+                "value": 80
+              }
+            ]
+          },
+          "unit": "none"
+        },
+        "overrides": [
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Info"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "rgb(80, 80, 80)",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Notice"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "rgb(182, 182, 182)",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Warning"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "#E0B400",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Error"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "#FF780A",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Critical"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "#E02F44",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Alert"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "#8F3BB8",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Emergency"
+            },
+            "properties": [
+              {
+                "id": "color",
+                "value": {
+                  "fixedColor": "#8F3BB8",
+                  "mode": "fixed"
+                }
+              },
+              {
+                "id": "custom.stacking",
+                "value": {
+                  "group": "A",
+                  "mode": "normal"
+                }
+              }
+            ]
+          }
+        ]
+      },
+      "gridPos": {
+        "h": 7,
+        "w": 24,
+        "x": 0,
+        "y": 0
+      },
+      "id": 10,
+      "options": {
+        "alertThreshold": true,
+        "legend": {
+          "calcs": [
+            "mean",
+            "max",
+            "sum"
+          ],
+          "displayMode": "table",
+          "placement": "right",
+          "showLegend": true
+        },
+        "tooltip": {
+          "mode": "multi",
+          "sort": "none"
+        }
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "alias": "Info",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PDD5124384626356D"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "A",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "info"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Notice",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PDD5124384626356D"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "B",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "notice"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Warning",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PDD5124384626356D"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "D",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "warning"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Error",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PDD5124384626356D"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "C",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "err"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Critical",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PDD5124384626356D"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "E",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "crit"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Alert",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PDD5124384626356D"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "F",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "alert"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        },
+        {
+          "alias": "Emergency",
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PDD5124384626356D"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "1m"
+              ],
+              "type": "time"
+            },
+            {
+              "params": [
+                "null"
+              ],
+              "type": "fill"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "G",
+          "resultFormat": "time_series",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              },
+              {
+                "params": [],
+                "type": "count"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "severity",
+              "operator": "=",
+              "value": "emerg"
+            },
+            {
+              "condition": "AND",
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        }
+      ],
+      "title": "syslog count",
+      "type": "timeseries"
+    },
+    {
+      "datasource": {
+        "type": "influxdb",
+        "uid": "PDD5124384626356D"
+      },
+      "description": "",
+      "fieldConfig": {
+        "defaults": {
+          "color": {
+            "mode": "thresholds"
+          },
+          "custom": {
+            "align": "left",
+            "cellOptions": {
+              "type": "auto"
+            },
+            "filterable": false,
+            "inspect": false
+          },
+          "mappings": [],
+          "thresholds": {
+            "mode": "absolute",
+            "steps": [
+              {
+                "color": "dark-purple",
+                "value": null
+              },
+              {
+                "color": "dark-red",
+                "value": 2
+              },
+              {
+                "color": "dark-orange",
+                "value": 3
+              },
+              {
+                "color": "dark-yellow",
+                "value": 4
+              },
+              {
+                "color": "rgb(150, 150, 150)",
+                "value": 5
+              },
+              {
+                "color": "rgb(51, 51, 51)",
+                "value": 6
+              },
+              {
+                "color": "rgb(5, 5, 5)",
+                "value": 7
+              }
+            ]
+          }
+        },
+        "overrides": [
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "severity_code"
+            },
+            "properties": [
+              {
+                "id": "mappings",
+                "value": [
+                  {
+                    "options": {
+                      "0": {
+                        "text": "Emergency"
+                      },
+                      "1": {
+                        "text": "Alert"
+                      },
+                      "2": {
+                        "text": "Critical"
+                      },
+                      "3": {
+                        "text": "Error"
+                      },
+                      "4": {
+                        "text": "Warning"
+                      },
+                      "5": {
+                        "text": "Notice"
+                      },
+                      "6": {
+                        "text": "Info"
+                      },
+                      "7": {
+                        "text": "Debug"
+                      }
+                    },
+                    "type": "value"
+                  }
+                ]
+              },
+              {
+                "id": "custom.cellOptions",
+                "value": {
+                  "mode": "gradient",
+                  "type": "color-background"
+                }
+              },
+              {
+                "id": "custom.width",
+                "value": 119
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "Time"
+            },
+            "properties": [
+              {
+                "id": "custom.width",
+                "value": 163
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "hostname"
+            },
+            "properties": [
+              {
+                "id": "custom.width",
+                "value": 194
+              }
+            ]
+          },
+          {
+            "matcher": {
+              "id": "byName",
+              "options": "appname"
+            },
+            "properties": [
+              {
+                "id": "custom.width",
+                "value": 264
+              }
+            ]
+          }
+        ]
+      },
+      "gridPos": {
+        "h": 24,
+        "w": 24,
+        "x": 0,
+        "y": 7
+      },
+      "id": 12,
+      "options": {
+        "cellHeight": "sm",
+        "footer": {
+          "countRows": false,
+          "fields": "",
+          "reducer": [
+            "sum"
+          ],
+          "show": false
+        },
+        "showHeader": true,
+        "sortBy": [
+          {
+            "desc": true,
+            "displayName": "Time"
+          }
+        ]
+      },
+      "pluginVersion": "11.4.0",
+      "targets": [
+        {
+          "datasource": {
+            "type": "influxdb",
+            "uid": "PDD5124384626356D"
+          },
+          "groupBy": [
+            {
+              "params": [
+                "hostname"
+              ],
+              "type": "tag"
+            },
+            {
+              "params": [
+                "appname"
+              ],
+              "type": "tag"
+            }
+          ],
+          "measurement": "syslog",
+          "orderByTime": "ASC",
+          "policy": "default",
+          "refId": "A",
+          "resultFormat": "table",
+          "select": [
+            [
+              {
+                "params": [
+                  "severity_code"
+                ],
+                "type": "field"
+              }
+            ],
+            [
+              {
+                "params": [
+                  "message"
+                ],
+                "type": "field"
+              }
+            ]
+          ],
+          "tags": [
+            {
+              "key": "hostname",
+              "operator": "=~",
+              "value": "/^$hostname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "appname",
+              "operator": "=~",
+              "value": "/^$appname$/"
+            },
+            {
+              "condition": "AND",
+              "key": "severity",
+              "operator": "=~",
+              "value": "/^$severity$/"
+            },
+            {
+              "condition": "AND",
+              "key": "message",
+              "operator": "=~",
+              "value": "/$Query/"
+            }
+          ]
+        }
+      ],
+      "title": "Syslog Messages",
+      "type": "table"
+    }
+  ],
+  "preload": false,
+  "refresh": "5s",
+  "schemaVersion": 40,
+  "tags": [],
+  "templating": {
+    "list": [
+      {
+        "current": {
+          "text": "All",
+          "value": [
+            "$__all"
+          ]
+        },
+        "datasource": "PDD5124384626356D",
+        "definition": "SHOW TAG VALUES FROM syslog WITH KEY=appname",
+        "includeAll": true,
+        "label": "Appname",
+        "multi": true,
+        "name": "appname",
+        "options": [],
+        "query": "SHOW TAG VALUES FROM syslog WITH KEY=appname",
+        "refresh": 2,
+        "regex": "",
+        "sort": 1,
+        "type": "query"
+      },
+      {
+        "current": {
+          "text": "All",
+          "value": [
+            "$__all"
+          ]
+        },
+        "datasource": "PDD5124384626356D",
+        "definition": "SHOW TAG VALUES FROM syslog WITH KEY=hostname",
+        "includeAll": true,
+        "label": "Hostname",
+        "multi": true,
+        "name": "hostname",
+        "options": [],
+        "query": "SHOW TAG VALUES FROM syslog WITH KEY=hostname",
+        "refresh": 2,
+        "regex": "",
+        "sort": 1,
+        "type": "query"
+      },
+      {
+        "current": {
+          "text": "All",
+          "value": [
+            "$__all"
+          ]
+        },
+        "datasource": "PDD5124384626356D",
+        "definition": "SHOW TAG VALUES FROM syslog WITH KEY=severity",
+        "includeAll": true,
+        "label": "Severity",
+        "multi": true,
+        "name": "severity",
+        "options": [],
+        "query": "SHOW TAG VALUES FROM syslog WITH KEY=severity",
+        "refresh": 2,
+        "regex": "",
+        "type": "query"
+      },
+      {
+        "current": {
+          "text": "",
+          "value": ""
+        },
+        "description": "Querystring",
+        "label": "MessageQuery",
+        "name": "Query",
+        "options": [
+          {
+            "selected": true,
+            "text": "",
+            "value": ""
+          }
+        ],
+        "query": "",
+        "type": "textbox"
+      }
+    ]
+  },
+  "time": {
+    "from": "now-1h",
+    "to": "now"
+  },
+  "timepicker": {
+    "refresh_intervals": [
+      "5s",
+      " 10s",
+      " 30s",
+      " 1m",
+      " 5m"
+    ]
+  },
+  "timezone": "",
+  "title": "Syslog",
+  "uid": "TIYeHqRgZ",
+  "version": 1,
+  "weekStart": ""
+}
\ No newline at end of file

changed: [andriikuiava-3] => (item=syslog.json)

TASK [grafana : Ensure Grafana container is running] ***************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
-    "exists": false,
-    "running": false
+    "exists": true,
+    "running": true
 }

changed: [andriikuiava-3]

TASK [grafana : Add CNAME for Grafana] *****************************************
changed: [andriikuiava-3]

RUNNING HANDLER [grafana : Restart Grafana] ************************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
-    "restarted": false,
+    "restarted": true,
     "running": true
 }

changed: [andriikuiava-3]

PLAY [Agama tasks] *************************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [agama : Create /opt/agama directory] *************************************
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/opt/agama",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-1]
--- before
+++ after
@@ -1,4 +1,4 @@
 {
     "path": "/opt/agama",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-2]

TASK [agama : Download Agama files] ********************************************
changed: [andriikuiava-1] => (item={'dest': 'agama.py', 'url': 'https://raw.githubusercontent.com/hudolejev/agama/master/agama.py'})
changed: [andriikuiava-2] => (item={'dest': 'agama.py', 'url': 'https://raw.githubusercontent.com/hudolejev/agama/master/agama.py'})
changed: [andriikuiava-2] => (item={'dest': 'Dockerfile', 'url': 'https://raw.githubusercontent.com/hudolejev/agama/master/Dockerfile'})
changed: [andriikuiava-1] => (item={'dest': 'Dockerfile', 'url': 'https://raw.githubusercontent.com/hudolejev/agama/master/Dockerfile'})

TASK [agama : Build Agama Docker image] ****************************************
changed: [andriikuiava-2]
changed: [andriikuiava-1]

TASK [agama : Create Agama Containers] *****************************************
changed: [andriikuiava-2] => (item=None)
changed: [andriikuiava-1] => (item=None)
changed: [andriikuiava-2] => (item=None)
changed: [andriikuiava-2]
changed: [andriikuiava-1] => (item=None)
changed: [andriikuiava-1]

TASK [agama : Add CNAME for Agama containers] **********************************
changed: [andriikuiava-2] => (item=None)
changed: [andriikuiava-1] => (item=None)
changed: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1] => (item=None)
changed: [andriikuiava-2]
changed: [andriikuiava-1]

PLAY [Agama client tasks] ******************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]

TASK [agama_client : Install fping] ********************************************
The following NEW packages will be installed:
  fping
0 upgraded, 1 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-3]

TASK [agama_client : Copy agama-client script to /usr/local/bin] ***************
--- before
+++ after: /Users/andriikuiava/IdeaProjects/ica0002/roles/agama_client/files/agama_client
@@ -0,0 +1,62 @@
+#!/bin/bash -eu
+
+# Please help Dora to find problems in this script
+
+for t in database_url database_name subnet; do
+    if ! grep -q "^${t}=" /etc/agama_client/agama_client.conf; then
+        logger "$0 Failed to get $t from config"
+        exit 1
+    fi
+done
+
+which fping > /dev/null || { logger "$0 fping not found"; exit 1; }
+
+logger "Starting agama-client..."
+
+db_url=$(grep "^database_url=" /etc/agama_client/agama_client.conf | sed 's/^.*=//')
+db_name=$(grep "^database_name=" /etc/agama_client/agama_client.conf | sed 's/^.*=//')
+subnet=$(grep "^subnet=" /etc/agama_client/agama_client.conf | sed 's/^.*=//')
+
+if $(curl -s "$db_url/ping"); then
+    logger "Will push data to $db_url"
+else
+    logger "Failed to connect to $db_url"
+    exit 1
+fi
+
+logger "Creating database $db_name in $db_url"
+curl -i -XPOST "$db_url/query" --data-urlencode "q=CREATE DATABASE $db_name" 1>/dev/null 2>/dev/null || { logger "$0 Failed to create database"; exit 1; }
+
+while true; do
+    alive_hosts=$(fping -g $subnet -a 2>/dev/null || true)
+    logger "Discovered $(echo "$alive_hosts" | wc -l) IPs"
+    for vm_ip in $alive_hosts; do
+        # Getting content of agama page
+        content=$(curl --connect-timeout 1 -w "%{http_code}" -s $vm_ip || continue)
+        if test ${content: -3} -ne 200; then
+            # nothing to do, going to next student
+            continue
+        fi
+        # Getting where it's hosted
+        vm_name=$(echo "$content" | grep "running on" | awk '{print $5}')
+        if [ -z $vm_name ]; then
+            # No agama running, skipping
+            continue
+        fi
+        # Number of items in agama
+        table_rows=$(echo "$content" | grep -c "</tr>")
+        # Write stats to inflixdb
+        curl -i -XPOST "${db_url}/write?db=$db_name" --data-binary "agama-stats,name=$vm_name items=$table_rows" 1>/dev/null 2>/dev/null
+        # If hostname exists in agama - delete it
+        if $(echo "$content" | grep -q $(hostname)); then
+            for delete_url in $(echo "$content" | grep $(hostname) | grep -o '/items/.*/swap-state' | sed 's/swap-state/delete/'); do
+                curl -s $vm_ip$delete_url -o /dev/null || logger "Failed to delete $(hostname) from $vm_ip"
+            done
+        fi
+        # Add new item to agama
+        curl -s -XPOST $vm_ip/items/add -F new_item="Checked from $(hostname) at $(date)" -o /dev/null || logger "Failed to update Agama on $vm_ip"
+        logger "Posted check message to $vm_ip"
+    done
+    logger "Waiting for the next cycle to start..."
+    sleep 300
+done
\ No newline at end of file

changed: [andriikuiava-3]

TASK [agama_client : Create agama-client user] *********************************
changed: [andriikuiava-3]

TASK [agama_client : Create directory for agama-client configuration] **********
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 998,
+    "owner": 998,
     "path": "/etc/agama_client",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-3]

TASK [agama_client : Copy agama-client configuration file] *********************
--- before
+++ after: /Users/andriikuiava/IdeaProjects/ica0002/roles/agama_client/files/agama_client.conf
@@ -0,0 +1,3 @@
+database_url=http://influxdb.megacoolproject.io:8086
+database_name=example
+subnet=192.168.42.0/24
\ No newline at end of file

changed: [andriikuiava-3]

TASK [agama_client : Copy agama-client systemd service file] *******************
--- before
+++ after: /Users/andriikuiava/IdeaProjects/ica0002/roles/agama_client/files/agama-client.service
@@ -0,0 +1,13 @@
+[Unit]
+Description=test
+After=network-online.target
+Wants=network-online.target
+
+[Service]
+User=agama-client
+ExecStart=/usr/local/bin/agama-client
+Restart=on-failure
+RestartSec=5
+
+[Install]
+WantedBy=multi-user.target
\ No newline at end of file

changed: [andriikuiava-3]

TASK [agama_client : Enable and start agama-client service] ********************
changed: [andriikuiava-3]

RUNNING HANDLER [agama_client : Reload Systemd] ********************************
ok: [andriikuiava-3]

PLAY [Web server tasks] ********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [nginx : Install nginx] ***************************************************
ok: [andriikuiava-3]
The following additional packages will be installed:
  fontconfig-config fonts-dejavu-core libdeflate0 libfontconfig1 libgd3
  libjbig0 libjpeg-turbo8 libjpeg8 libnginx-mod-http-geoip2
  libnginx-mod-http-image-filter libnginx-mod-http-xslt-filter
  libnginx-mod-mail libnginx-mod-stream libnginx-mod-stream-geoip2 libtiff5
  libwebp7 libxpm4 nginx-common nginx-core
Suggested packages:
  libgd-tools fcgiwrap nginx-doc ssl-cert
The following NEW packages will be installed:
  fontconfig-config fonts-dejavu-core libdeflate0 libfontconfig1 libgd3
  libjbig0 libjpeg-turbo8 libjpeg8 libnginx-mod-http-geoip2
  libnginx-mod-http-image-filter libnginx-mod-http-xslt-filter
  libnginx-mod-mail libnginx-mod-stream libnginx-mod-stream-geoip2 libtiff5
  libwebp7 libxpm4 nginx nginx-common nginx-core
0 upgraded, 20 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-2]
The following additional packages will be installed:
  fontconfig-config fonts-dejavu-core libdeflate0 libfontconfig1 libgd3
  libjbig0 libjpeg-turbo8 libjpeg8 libnginx-mod-http-geoip2
  libnginx-mod-http-image-filter libnginx-mod-http-xslt-filter
  libnginx-mod-mail libnginx-mod-stream libnginx-mod-stream-geoip2 libtiff5
  libwebp7 libxpm4 nginx-common nginx-core
Suggested packages:
  libgd-tools fcgiwrap nginx-doc ssl-cert
The following NEW packages will be installed:
  fontconfig-config fonts-dejavu-core libdeflate0 libfontconfig1 libgd3
  libjbig0 libjpeg-turbo8 libjpeg8 libnginx-mod-http-geoip2
  libnginx-mod-http-image-filter libnginx-mod-http-xslt-filter
  libnginx-mod-mail libnginx-mod-stream libnginx-mod-stream-geoip2 libtiff5
  libwebp7 libxpm4 nginx nginx-common nginx-core
0 upgraded, 20 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-1]

TASK [nginx : Copy Nginx config to sites-enabled] ******************************
--- before: /etc/nginx/sites-enabled/default
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmps1cqap1l/default.j2
@@ -1,91 +1,20 @@
-##
-# You should look at the following URL's in order to grasp a solid understanding
-# of Nginx configuration files in order to fully unleash the power of Nginx.
-# https://www.nginx.com/resources/wiki/start/
-# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
-# https://wiki.debian.org/Nginx/DirectoryStructure
-#
-# In most cases, administrators will remove this file from sites-enabled/ and
-# leave it as reference inside of sites-available where it will continue to be
-# updated by the nginx packaging team.
-#
-# This file will automatically load configuration files provided by other
-# applications, such as Drupal or Wordpress. These applications will be made
-# available underneath a path with that package name, such as /drupal8.
-#
-# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
-##
+server {
+    listen 80 default_server;
+    server_name _;

-# Default server configuration
-#
-server {
-	listen 80 default_server;
-	listen [::]:80 default_server;
-
-	# SSL configuration
-	#
-	# listen 443 ssl default_server;
-	# listen [::]:443 ssl default_server;
-	#
-	# Note: You should disable gzip for SSL traffic.
-	# See: https://bugs.debian.org/773332
-	#
-	# Read up on ssl_ciphers to ensure a secure configuration.
-	# See: https://bugs.debian.org/765782
-	#
-	# Self signed certs generated by the ssl-cert package
-	# Don't use them in a production server!
-	#
-	# include snippets/snakeoil.conf;
-
-	root /var/www/html;
-
-	# Add index.php to the list if you are using PHP
-	index index.html index.htm index.nginx-debian.html;
-
-	server_name _;
-
-	location / {
-		# First attempt to serve request as file, then
-		# as directory, then fall back to displaying a 404.
-		try_files $uri $uri/ =404;
-	}
-
-	# pass PHP scripts to FastCGI server
-	#
-	#location ~ \.php$ {
-	#	include snippets/fastcgi-php.conf;
-	#
-	#	# With php-fpm (or other unix sockets):
-	#	fastcgi_pass unix:/run/php/php7.4-fpm.sock;
-	#	# With php-cgi (or other tcp sockets):
-	#	fastcgi_pass 127.0.0.1:9000;
-	#}
-
-	# deny access to .htaccess files, if Apache's document root
-	# concurs with nginx's one
-	#
-	#location ~ /\.ht {
-	#	deny all;
-	#}
+
+
+        location / {
+        proxy_set_header Host $http_host;
+        proxy_pass http://localhost:8001;
+    }
+
+    location /nginx_status {
+        stub_status;
+        allow 127.0.0.1;
+        deny all;
+    }
 }


-# Virtual Host configuration for example.com
-#
-# You can move that to a different file under sites-available/ and symlink that
-# to sites-enabled/ to enable it.
-#
-#server {
-#	listen 80;
-#	listen [::]:80;
-#
-#	server_name example.com;
-#
-#	root /var/www/example.com;
-#	index index.html;
-#
-#	location / {
-#		try_files $uri $uri/ =404;
-#	}
-#}
+

changed: [andriikuiava-2]
--- before: /etc/nginx/sites-enabled/default
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpqwo8aq5w/default.j2
@@ -1,91 +1,20 @@
-##
-# You should look at the following URL's in order to grasp a solid understanding
-# of Nginx configuration files in order to fully unleash the power of Nginx.
-# https://www.nginx.com/resources/wiki/start/
-# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
-# https://wiki.debian.org/Nginx/DirectoryStructure
-#
-# In most cases, administrators will remove this file from sites-enabled/ and
-# leave it as reference inside of sites-available where it will continue to be
-# updated by the nginx packaging team.
-#
-# This file will automatically load configuration files provided by other
-# applications, such as Drupal or Wordpress. These applications will be made
-# available underneath a path with that package name, such as /drupal8.
-#
-# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
-##
+server {
+    listen 80 default_server;
+    server_name _;

-# Default server configuration
-#
-server {
-	listen 80 default_server;
-	listen [::]:80 default_server;
-
-	# SSL configuration
-	#
-	# listen 443 ssl default_server;
-	# listen [::]:443 ssl default_server;
-	#
-	# Note: You should disable gzip for SSL traffic.
-	# See: https://bugs.debian.org/773332
-	#
-	# Read up on ssl_ciphers to ensure a secure configuration.
-	# See: https://bugs.debian.org/765782
-	#
-	# Self signed certs generated by the ssl-cert package
-	# Don't use them in a production server!
-	#
-	# include snippets/snakeoil.conf;
-
-	root /var/www/html;
-
-	# Add index.php to the list if you are using PHP
-	index index.html index.htm index.nginx-debian.html;
-
-	server_name _;
-
-	location / {
-		# First attempt to serve request as file, then
-		# as directory, then fall back to displaying a 404.
-		try_files $uri $uri/ =404;
-	}
-
-	# pass PHP scripts to FastCGI server
-	#
-	#location ~ \.php$ {
-	#	include snippets/fastcgi-php.conf;
-	#
-	#	# With php-fpm (or other unix sockets):
-	#	fastcgi_pass unix:/run/php/php7.4-fpm.sock;
-	#	# With php-cgi (or other tcp sockets):
-	#	fastcgi_pass 127.0.0.1:9000;
-	#}
-
-	# deny access to .htaccess files, if Apache's document root
-	# concurs with nginx's one
-	#
-	#location ~ /\.ht {
-	#	deny all;
-	#}
+
+
+        location / {
+        proxy_set_header Host $http_host;
+        proxy_pass http://localhost:8001;
+    }
+
+    location /nginx_status {
+        stub_status;
+        allow 127.0.0.1;
+        deny all;
+    }
 }


-# Virtual Host configuration for example.com
-#
-# You can move that to a different file under sites-available/ and symlink that
-# to sites-enabled/ to enable it.
-#
-#server {
-#	listen 80;
-#	listen [::]:80;
-#
-#	server_name example.com;
-#
-#	root /var/www/example.com;
-#	index index.html;
-#
-#	location / {
-#		try_files $uri $uri/ =404;
-#	}
-#}
+

changed: [andriikuiava-1]
--- before: /etc/nginx/sites-enabled/default
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpxdugy7n9/default.j2
@@ -1,91 +1,23 @@
-##
-# You should look at the following URL's in order to grasp a solid understanding
-# of Nginx configuration files in order to fully unleash the power of Nginx.
-# https://www.nginx.com/resources/wiki/start/
-# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
-# https://wiki.debian.org/Nginx/DirectoryStructure
-#
-# In most cases, administrators will remove this file from sites-enabled/ and
-# leave it as reference inside of sites-available where it will continue to be
-# updated by the nginx packaging team.
-#
-# This file will automatically load configuration files provided by other
-# applications, such as Drupal or Wordpress. These applications will be made
-# available underneath a path with that package name, such as /drupal8.
-#
-# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
-##
+server {
+    listen 80 default_server;
+    server_name _;

-# Default server configuration
-#
-server {
-	listen 80 default_server;
-	listen [::]:80 default_server;
-
-	# SSL configuration
-	#
-	# listen 443 ssl default_server;
-	# listen [::]:443 ssl default_server;
-	#
-	# Note: You should disable gzip for SSL traffic.
-	# See: https://bugs.debian.org/773332
-	#
-	# Read up on ssl_ciphers to ensure a secure configuration.
-	# See: https://bugs.debian.org/765782
-	#
-	# Self signed certs generated by the ssl-cert package
-	# Don't use them in a production server!
-	#
-	# include snippets/snakeoil.conf;
-
-	root /var/www/html;
-
-	# Add index.php to the list if you are using PHP
-	index index.html index.htm index.nginx-debian.html;
-
-	server_name _;
-
-	location / {
-		# First attempt to serve request as file, then
-		# as directory, then fall back to displaying a 404.
-		try_files $uri $uri/ =404;
-	}
-
-	# pass PHP scripts to FastCGI server
-	#
-	#location ~ \.php$ {
-	#	include snippets/fastcgi-php.conf;
-	#
-	#	# With php-fpm (or other unix sockets):
-	#	fastcgi_pass unix:/run/php/php7.4-fpm.sock;
-	#	# With php-cgi (or other tcp sockets):
-	#	fastcgi_pass 127.0.0.1:9000;
-	#}
-
-	# deny access to .htaccess files, if Apache's document root
-	# concurs with nginx's one
-	#
-	#location ~ /\.ht {
-	#	deny all;
-	#}
+        location /prometheus {
+        proxy_pass http://localhost:9090;
+    }
+
+        	location /grafana {
+    		proxy_set_header Host $http_host;
+    		proxy_pass http://localhost:3001;
+    	}
+
+
+    location /nginx_status {
+        stub_status;
+        allow 127.0.0.1;
+        deny all;
+    }
 }


-# Virtual Host configuration for example.com
-#
-# You can move that to a different file under sites-available/ and symlink that
-# to sites-enabled/ to enable it.
-#
-#server {
-#	listen 80;
-#	listen [::]:80;
-#
-#	server_name example.com;
-#
-#	root /var/www/example.com;
-#	index index.html;
-#
-#	location / {
-#		try_files $uri $uri/ =404;
-#	}
-#}
+

changed: [andriikuiava-3]

TASK [nginx : Ensure Nginx service is running] *********************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]
ok: [andriikuiava-3]

TASK [nginx : Install Nginx exporter] ******************************************
The following NEW packages will be installed:
  prometheus-nginx-exporter
0 upgraded, 1 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-1]
The following NEW packages will be installed:
  prometheus-nginx-exporter
0 upgraded, 1 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-2]
The following NEW packages will be installed:
  prometheus-nginx-exporter
0 upgraded, 1 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-3]

TASK [nginx : Add scrape-uri to prometheus-nginx-exporter systemd service] *****
--- before: /lib/systemd/system/prometheus-nginx-exporter.service (content)
+++ after: /lib/systemd/system/prometheus-nginx-exporter.service (content)
@@ -7,7 +7,7 @@
 Restart=on-failure
 User=prometheus
 EnvironmentFile=/etc/default/prometheus-nginx-exporter
-ExecStart=/usr/bin/prometheus-nginx-exporter $ARGS
+ExecStart=/usr/bin/prometheus-nginx-exporter -nginx.scrape-uri http://localhost/nginx_status

 [Install]
 WantedBy=multi-user.target

changed: [andriikuiava-1]
--- before: /lib/systemd/system/prometheus-nginx-exporter.service (content)
+++ after: /lib/systemd/system/prometheus-nginx-exporter.service (content)
@@ -7,7 +7,7 @@
 Restart=on-failure
 User=prometheus
 EnvironmentFile=/etc/default/prometheus-nginx-exporter
-ExecStart=/usr/bin/prometheus-nginx-exporter $ARGS
+ExecStart=/usr/bin/prometheus-nginx-exporter -nginx.scrape-uri http://localhost/nginx_status

 [Install]
 WantedBy=multi-user.target

changed: [andriikuiava-3]
--- before: /lib/systemd/system/prometheus-nginx-exporter.service (content)
+++ after: /lib/systemd/system/prometheus-nginx-exporter.service (content)
@@ -7,7 +7,7 @@
 Restart=on-failure
 User=prometheus
 EnvironmentFile=/etc/default/prometheus-nginx-exporter
-ExecStart=/usr/bin/prometheus-nginx-exporter $ARGS
+ExecStart=/usr/bin/prometheus-nginx-exporter -nginx.scrape-uri http://localhost/nginx_status

 [Install]
 WantedBy=multi-user.target

changed: [andriikuiava-2]

TASK [nginx : Reload systemd daemon] *******************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]
ok: [andriikuiava-3]

TASK [nginx : Make sure Nginx exporter is running] *****************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]
changed: [andriikuiava-3]

RUNNING HANDLER [nginx : Restart Nginx] ****************************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]
changed: [andriikuiava-3]

RUNNING HANDLER [nginx : Reload Systemd and Restart Nginx Exporter] ************
changed: [andriikuiava-3]
changed: [andriikuiava-1]
changed: [andriikuiava-2]

PLAY [Influxdb tasks] **********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]

TASK [influxdb : Download InfluxDB .deb package] *******************************
changed: [andriikuiava-3]

TASK [influxdb : Install InfluxDB] *********************************************
Selecting previously unselected package influxdb.
(Reading database ... 59648 files and directories currently installed.)
Preparing to unpack /home/ubuntu/influxdb ...
Unpacking influxdb (1.8.10-1) ...
Setting up influxdb (1.8.10-1) ...
Processing triggers for man-db (2.10.2-1) ...
changed: [andriikuiava-3]

TASK [influxdb : Ensure InfluxDB is enabled and started] ***********************
changed: [andriikuiava-3]

TASK [influxdb : Install Telegraf] *********************************************
The following NEW packages will be installed:
  telegraf
0 upgraded, 1 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-3]

TASK [influxdb : Configure Telegraf] *******************************************
diff skipped: destination file size is greater than 104448
changed: [andriikuiava-3]

TASK [influxdb : Ensure Telegraf is running and enabled] ***********************
ok: [andriikuiava-3]

TASK [influxdb : Download InfluxDB Stats Exporter binary] **********************
changed: [andriikuiava-3]

TASK [influxdb : Create systemd service for InfluxDB Stats Exporter] ***********
--- before
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpekvayyis/prometheus-influxdb-stats-exporter.service.j2
@@ -0,0 +1,10 @@
+[Unit]
+Description=InfluxDB Stats Exporter
+After=network.target
+
+[Service]
+User=prometheus
+ExecStart=/usr/local/bin/influxdb_stats_exporter --influx.url=http://localhost:8086
+
+[Install]
+WantedBy=multi-user.target
\ No newline at end of file

changed: [andriikuiava-3]

TASK [influxdb : Ensure InfluxDB Stats Exporter is running and enabled] ********
changed: [andriikuiava-3]

TASK [influxdb : Ensure /home/backup/influxdb directory exists] ****************
--- before
+++ after
@@ -1,6 +1,6 @@
 {
-    "group": 0,
-    "owner": 0,
+    "group": 34,
+    "owner": 34,
     "path": "/home/backup/influxdb",
-    "state": "absent"
+    "state": "directory"
 }

changed: [andriikuiava-3]

TASK [influxdb : Ensure backup directory exists] *******************************
ok: [andriikuiava-3]

TASK [influxdb : Configure InfluxDB backup cron job] ***************************
--- before
+++ after: /etc/cron.d/influxdb-backup
@@ -0,0 +1,2 @@
+12 0 * * * backup rm -rf /home/backup/influxdb/*; influxd backup -portable -db telegraf /home/backup/influxdb
+12 0 * * 0 backup duplicity --no-encryption full /home/backup/influxdb/ rsync://andriikuiava@backup.megacoolproject.io/influxdb

changed: [andriikuiava-3]

TASK [influxdb : Add CNAME for InfluxDB] ***************************************
changed: [andriikuiava-3]

RUNNING HANDLER [influxdb : Restart Telegraf] **********************************
changed: [andriikuiava-3]

RUNNING HANDLER [influxdb : Restart InfluxDB Stats Exporter] *******************
changed: [andriikuiava-3]

RUNNING HANDLER [influxdb : Reload Systemd] ************************************
ok: [andriikuiava-3]

PLAY [Haproxy tasks] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [haproxy : Install haproxy] ***********************************************
The following additional packages will be installed:
  liblua5.3-0
Suggested packages:
  vim-haproxy haproxy-doc
The following NEW packages will be installed:
  haproxy liblua5.3-0
0 upgraded, 2 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-2]
The following additional packages will be installed:
  liblua5.3-0
Suggested packages:
  vim-haproxy haproxy-doc
The following NEW packages will be installed:
  haproxy liblua5.3-0
0 upgraded, 2 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-1]

TASK [haproxy : Copy the Haproxy config] ***************************************
--- before: /etc/haproxy/haproxy.cfg
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmp1q9jt02v/haproxy.cnf.j2
@@ -1,34 +1,42 @@
 global
-	log /dev/log	local0
-	log /dev/log	local1 notice
-	chroot /var/lib/haproxy
-	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
-	stats timeout 30s
-	user haproxy
-	group haproxy
-	daemon
-
-	# Default SSL material locations
-	ca-base /etc/ssl/certs
-	crt-base /etc/ssl/private
-
-	# See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
-        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
-        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
-        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
+ log /dev/log local0
+ log /dev/log local1 notice
+ chroot /var/lib/haproxy
+ stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
+ stats timeout 30s
+ user haproxy
+ group haproxy
+ daemon

 defaults
-	log	global
-	mode	http
-	option	httplog
-	option	dontlognull
+ log global
+ mode http
+ option httplog
+ option dontlognull
         timeout connect 5000
         timeout client  50000
         timeout server  50000
-	errorfile 400 /etc/haproxy/errors/400.http
-	errorfile 403 /etc/haproxy/errors/403.http
-	errorfile 408 /etc/haproxy/errors/408.http
-	errorfile 500 /etc/haproxy/errors/500.http
-	errorfile 502 /etc/haproxy/errors/502.http
-	errorfile 503 /etc/haproxy/errors/503.http
-	errorfile 504 /etc/haproxy/errors/504.http
+ errorfile 400 /etc/haproxy/errors/400.http
+ errorfile 403 /etc/haproxy/errors/403.http
+ errorfile 408 /etc/haproxy/errors/408.http
+ errorfile 500 /etc/haproxy/errors/500.http
+ errorfile 502 /etc/haproxy/errors/502.http
+ errorfile 503 /etc/haproxy/errors/503.http
+ errorfile 504 /etc/haproxy/errors/504.http
+frontend my_ha_frontend
+    bind *:88
+    default_backend my_ha_backend
+
+backend my_ha_backend
+            server docker1 www-1.megacoolproject.io:8001 check
+            server docker2 www-1.megacoolproject.io:8002 check
+                server docker3 www-2.megacoolproject.io:8001 check
+            server docker4 www-2.megacoolproject.io:8002 check
+
+listen stats
+    bind :9188
+    mode http
+    stats enable
+    stats uri /metrics
+    stats realm HAProxy\ Statistics
+

changed: [andriikuiava-2]
--- before: /etc/haproxy/haproxy.cfg
+++ after: /Users/andriikuiava/.ansible/tmp/ansible-local-4466025eqcgwf/tmpwy3vw2o_/haproxy.cnf.j2
@@ -1,34 +1,42 @@
 global
-	log /dev/log	local0
-	log /dev/log	local1 notice
-	chroot /var/lib/haproxy
-	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
-	stats timeout 30s
-	user haproxy
-	group haproxy
-	daemon
-
-	# Default SSL material locations
-	ca-base /etc/ssl/certs
-	crt-base /etc/ssl/private
-
-	# See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
-        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
-        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
-        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
+ log /dev/log local0
+ log /dev/log local1 notice
+ chroot /var/lib/haproxy
+ stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
+ stats timeout 30s
+ user haproxy
+ group haproxy
+ daemon

 defaults
-	log	global
-	mode	http
-	option	httplog
-	option	dontlognull
+ log global
+ mode http
+ option httplog
+ option dontlognull
         timeout connect 5000
         timeout client  50000
         timeout server  50000
-	errorfile 400 /etc/haproxy/errors/400.http
-	errorfile 403 /etc/haproxy/errors/403.http
-	errorfile 408 /etc/haproxy/errors/408.http
-	errorfile 500 /etc/haproxy/errors/500.http
-	errorfile 502 /etc/haproxy/errors/502.http
-	errorfile 503 /etc/haproxy/errors/503.http
-	errorfile 504 /etc/haproxy/errors/504.http
+ errorfile 400 /etc/haproxy/errors/400.http
+ errorfile 403 /etc/haproxy/errors/403.http
+ errorfile 408 /etc/haproxy/errors/408.http
+ errorfile 500 /etc/haproxy/errors/500.http
+ errorfile 502 /etc/haproxy/errors/502.http
+ errorfile 503 /etc/haproxy/errors/503.http
+ errorfile 504 /etc/haproxy/errors/504.http
+frontend my_ha_frontend
+    bind *:88
+    default_backend my_ha_backend
+
+backend my_ha_backend
+            server docker1 www-1.megacoolproject.io:8001 check
+            server docker2 www-1.megacoolproject.io:8002 check
+                server docker3 www-2.megacoolproject.io:8001 check
+            server docker4 www-2.megacoolproject.io:8002 check
+
+listen stats
+    bind :9188
+    mode http
+    stats enable
+    stats uri /metrics
+    stats realm HAProxy\ Statistics
+

changed: [andriikuiava-1]

TASK [haproxy : Ensure HAProxy is enabled and started] *************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [haproxy : Install prometheus-haproxy-exporter] ***************************
The following NEW packages will be installed:
  prometheus-haproxy-exporter
0 upgraded, 1 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-2]
The following NEW packages will be installed:
  prometheus-haproxy-exporter
0 upgraded, 1 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-1]

TASK [haproxy : Update prometheus-haproxy-exporter ARGS] ***********************
--- before: /etc/default/prometheus-haproxy-exporter (content)
+++ after: /etc/default/prometheus-haproxy-exporter (content)
@@ -2,7 +2,7 @@
 # Due to shell scaping, to pass backslashes for regexes, you need to double
 # them (\\d for \d). If running under systemd, you need to double them again
 # (\\\\d to mean \d), and escape newlines too.
-ARGS=""
+ARGS="--haproxy.scrape-uri=http://127.0.0.1:9188/metrics;csv"

 # Prometheus-haproxy-exporter supports the following options:
 #

changed: [andriikuiava-2]
--- before: /etc/default/prometheus-haproxy-exporter (content)
+++ after: /etc/default/prometheus-haproxy-exporter (content)
@@ -2,7 +2,7 @@
 # Due to shell scaping, to pass backslashes for regexes, you need to double
 # them (\\d for \d). If running under systemd, you need to double them again
 # (\\\\d to mean \d), and escape newlines too.
-ARGS=""
+ARGS="--haproxy.scrape-uri=http://127.0.0.1:9188/metrics;csv"

 # Prometheus-haproxy-exporter supports the following options:
 #

changed: [andriikuiava-1]

TASK [haproxy : Ensure prometheus-haproxy-exporter is running] *****************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [haproxy : Ensure prometheus-haproxy-exporter is enabled and started] *****
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [haproxy : Add CNAME for HAProxy instances] *******************************
ok: [andriikuiava-1] => (item=None)
changed: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1] => (item=None)
changed: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1]
changed: [andriikuiava-2]

RUNNING HANDLER [haproxy : Restart Haproxy] ************************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]

RUNNING HANDLER [haproxy : restart prometheus-haproxy-exporter] ****************
changed: [andriikuiava-1]
changed: [andriikuiava-2]

PLAY [Keepalived tasks] ********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [keepalived : Install keepalived] *****************************************
The following additional packages will be installed:
  ipvsadm libsensors-config libsensors5 libsnmp-base libsnmp40
Suggested packages:
  heartbeat ldirectord lm-sensors snmp-mibs-downloader
The following NEW packages will be installed:
  ipvsadm keepalived libsensors-config libsensors5 libsnmp-base libsnmp40
0 upgraded, 6 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-1]
The following additional packages will be installed:
  ipvsadm libsensors-config libsensors5 libsnmp-base libsnmp40
Suggested packages:
  heartbeat ldirectord lm-sensors snmp-mibs-downloader
The following NEW packages will be installed:
  ipvsadm keepalived libsensors-config libsensors5 libsnmp-base libsnmp40
0 upgraded, 6 newly installed, 0 to remove and 130 not upgraded.
changed: [andriikuiava-2]

TASK [keepalived : Copy check script to keepalived_script user's home folder] ***
--- before
+++ after: /Users/andriikuiava/IdeaProjects/ica0002/roles/keepalived/files/script.sh
@@ -0,0 +1,2 @@
+#!/bin/bash
+ss -ntl | grep -q ':88 '
\ No newline at end of file

changed: [andriikuiava-1]
--- before
+++ after: /Users/andriikuiava/IdeaProjects/ica0002/roles/keepalived/files/script.sh
@@ -0,0 +1,2 @@
+#!/bin/bash
+ss -ntl | grep -q ':88 '
\ No newline at end of file

changed: [andriikuiava-2]

TASK [keepalived : Copy the Keepalived config] *********************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]

TASK [keepalived : Download Keepalived Exporter] *******************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]

TASK [keepalived : Extract Keepalived Exporter] ********************************
changed: [andriikuiava-1]
changed: [andriikuiava-2]

TASK [keepalived : Create systemd unit file] ***********************************
changed: [andriikuiava-2]
changed: [andriikuiava-1]

TASK [keepalived : Start the service] ******************************************
changed: [andriikuiava-1] => (item=keepalived)
changed: [andriikuiava-2] => (item=keepalived)
changed: [andriikuiava-2] => (item=keepalived-exporter)
changed: [andriikuiava-1] => (item=keepalived-exporter)

RUNNING HANDLER [keepalived : Restart keepalived] ******************************
changed: [andriikuiava-2]
changed: [andriikuiava-1]

RUNNING HANDLER [keepalived : Reload systemd] **********************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

PLAY RECAP *********************************************************************
andriikuiava-1             : ok=105  changed=74   unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
andriikuiava-2             : ok=105  changed=76   unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
andriikuiava-3             : ok=101  changed=70   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

+ ansible-playbook infra.yaml --diff

PLAY [Always gather facts for all hosts] ***************************************

TASK [Gathering Facts] *********************************************************
[WARNING]: Platform linux on host andriikuiava-2 is using the discovered Python
interpreter at /usr/bin/python3.10, but future installation of another Python
interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
[WARNING]: Platform linux on host andriikuiava-1 is using the discovered Python
interpreter at /usr/bin/python3.10, but future installation of another Python
interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
[WARNING]: Platform linux on host andriikuiava-3 is using the discovered Python
interpreter at /usr/bin/python3.10, but future installation of another Python
interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
ok: [andriikuiava-2]
ok: [andriikuiava-1]
ok: [andriikuiava-3]

PLAY [Initial setup] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [init : Update APT cache] *************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [init : Install Prometheus Node Exporter] *********************************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [init : Ensure Prometheus Node Exporter service is running] ***************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [init : Ensure rsyslog is installed] **************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [init : Copy rsyslog configuration for Telegraf] **************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [init : Ensure backup user exists with the correct home directory] ********
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [init : Ensure .ssh directory exists for backup user] *********************
ok: [andriikuiava-1]
ok: [andriikuiava-2]
ok: [andriikuiava-3]

TASK [init : Check if SSH key pair exists] *************************************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [init : Generate SSH key pair for backup user] ****************************
skipping: [andriikuiava-1]
skipping: [andriikuiava-2]
skipping: [andriikuiava-3]

TASK [init : Set permissions on the public key file] ***************************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [init : Ensure known_hosts file exists for backup user] *******************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [init : Ensure backup user can access backup server without prompts] ******
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [init : Add backup server to known_hosts] *********************************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [init : Set permissions for backup SSH keys] ******************************
ok: [andriikuiava-2] => (item=id_rsa)
ok: [andriikuiava-1] => (item=id_rsa)
ok: [andriikuiava-3] => (item=id_rsa)
ok: [andriikuiava-2] => (item=id_rsa.pub)
ok: [andriikuiava-1] => (item=id_rsa.pub)
ok: [andriikuiava-3] => (item=id_rsa.pub)

TASK [init : Ensure /home/backup/restore directory exists] *********************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [init : Ensure duplicity is installed] ************************************
[WARNING]: Could not match supplied host pattern, ignoring: children
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

PLAY [DNS Servers] *************************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [bind : Install Bind9] ****************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [bind : Configure DNS forwarders] *****************************************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [bind : Create master zone file] ******************************************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [bind : Create reverse zone file] *****************************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [bind : Configure Bind9 zones] ********************************************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [bind : Run handlers] *****************************************************

TASK [bind : Run handlers] *****************************************************

TASK [bind : Run handlers] *****************************************************

TASK [bind : Ensure Bind9 is running and enabled on boot] **********************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [bind : Download Bind9 exporter] ******************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]
ok: [andriikuiava-3]

TASK [bind : Unarchive Bind9 exporter] *****************************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [bind : Create symlink for Bind9 exporter] ********************************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [bind : Create systemd service for Bind9 exporter] ************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [bind : Reload systemd] ***************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [bind : Start Bind9 exporter service] *************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]
ok: [andriikuiava-3]

TASK [bind : Add A record for backup server] ***********************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [bind : Add CNAME for Bind9 servers] **************************************
ok: [andriikuiava-3] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-3] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-1]
ok: [andriikuiava-3] => (item=None)
ok: [andriikuiava-3]
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-2]

PLAY [Resolv DNS] **************************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [resolv_dns : Disable systemd-resolved] ***********************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [resolv_dns : Create resolv.conf with DNS settings] ***********************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

PLAY [Database Server] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Install MySQL server] ********************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Install PyMySQL] *************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Ensure MySQL service is running] *********************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Wait for MySQL to be ready] **************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Create MySQL override configuration] *****************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : MySQL database] **************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : MySQL user] ******************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Install MySQL exporter] ******************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Create MySQL user for exporter] **********************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Configure MySQL exporter credentials] ****************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Ensure /home/backup/mysql directory exists] **********************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Create MySQL backup user] ****************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Create MySQL client configuration file for backup user] **********
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Ensure /home/backup/mysql directory exists] **********************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Create Cron job for MySQL backups] *******************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Create MySQL replication user] ***********************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Set MySQL read_only mode dynamically] ****************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Add CNAME for MySQL instances] ***********************************
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1]
ok: [andriikuiava-2]

PLAY [Prometheus Servers] ******************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]

TASK [prometheus : Install Prometheus] *****************************************
ok: [andriikuiava-3]

TASK [prometheus : Configure Prometheus Service] *******************************
ok: [andriikuiava-3]

TASK [prometheus : Configure Prometheus] ***************************************
ok: [andriikuiava-3]

TASK [prometheus : Run Prometheus] *********************************************
ok: [andriikuiava-3]

TASK [prometheus : Install Nginx] **********************************************
ok: [andriikuiava-3]

TASK [prometheus : Start Nginx] ************************************************
ok: [andriikuiava-3]

TASK [prometheus : Add CNAME for Prometheus] ***********************************
ok: [andriikuiava-3]

PLAY [Docker] ******************************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [docker : Install Docker.io package] **************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [docker : Install python3-docker package] *********************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [docker : Ensure Docker daemon is running and enabled] ********************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

PLAY [Grafana Tasks] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]

TASK [grafana : Create required directories for Grafana provisioning] **********
ok: [andriikuiava-3] => (item=dashboards)
ok: [andriikuiava-3] => (item=datasources)

TASK [grafana : Copy grafana.ini configuration] ********************************
ok: [andriikuiava-3]

TASK [grafana : Copy dashboard provisioning configuration] *********************
ok: [andriikuiava-3]

TASK [grafana : Copy datasource provisioning configuration] ********************
ok: [andriikuiava-3]

TASK [grafana : Copy dashboards JSON files] ************************************
ok: [andriikuiava-3] => (item=backups.json)
ok: [andriikuiava-3] => (item=main.json)
ok: [andriikuiava-3] => (item=mysql.json)
ok: [andriikuiava-3] => (item=syslog.json)

TASK [grafana : Ensure Grafana container is running] ***************************
ok: [andriikuiava-3]

TASK [grafana : Add CNAME for Grafana] *****************************************
ok: [andriikuiava-3]

PLAY [Agama tasks] *************************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [agama : Create /opt/agama directory] *************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [agama : Download Agama files] ********************************************
ok: [andriikuiava-2] => (item={'dest': 'agama.py', 'url': 'https://raw.githubusercontent.com/hudolejev/agama/master/agama.py'})
ok: [andriikuiava-1] => (item={'dest': 'agama.py', 'url': 'https://raw.githubusercontent.com/hudolejev/agama/master/agama.py'})
ok: [andriikuiava-2] => (item={'dest': 'Dockerfile', 'url': 'https://raw.githubusercontent.com/hudolejev/agama/master/Dockerfile'})
ok: [andriikuiava-1] => (item={'dest': 'Dockerfile', 'url': 'https://raw.githubusercontent.com/hudolejev/agama/master/Dockerfile'})

TASK [agama : Build Agama Docker image] ****************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [agama : Create Agama Containers] *****************************************
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [agama : Add CNAME for Agama containers] **********************************
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1]
ok: [andriikuiava-2]

PLAY [Agama client tasks] ******************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]

TASK [agama_client : Install fping] ********************************************
ok: [andriikuiava-3]

TASK [agama_client : Copy agama-client script to /usr/local/bin] ***************
ok: [andriikuiava-3]

TASK [agama_client : Create agama-client user] *********************************
ok: [andriikuiava-3]

TASK [agama_client : Create directory for agama-client configuration] **********
ok: [andriikuiava-3]

TASK [agama_client : Copy agama-client configuration file] *********************
ok: [andriikuiava-3]

TASK [agama_client : Copy agama-client systemd service file] *******************
ok: [andriikuiava-3]

TASK [agama_client : Enable and start agama-client service] ********************
ok: [andriikuiava-3]

PLAY [Web server tasks] ********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [nginx : Install nginx] ***************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [nginx : Copy Nginx config to sites-enabled] ******************************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [nginx : Ensure Nginx service is running] *********************************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [nginx : Install Nginx exporter] ******************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [nginx : Add scrape-uri to prometheus-nginx-exporter systemd service] *****
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [nginx : Reload systemd daemon] *******************************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [nginx : Make sure Nginx exporter is running] *****************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

PLAY [Influxdb tasks] **********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]

TASK [influxdb : Download InfluxDB .deb package] *******************************
ok: [andriikuiava-3]

TASK [influxdb : Install InfluxDB] *********************************************
ok: [andriikuiava-3]

TASK [influxdb : Ensure InfluxDB is enabled and started] ***********************
ok: [andriikuiava-3]

TASK [influxdb : Install Telegraf] *********************************************
ok: [andriikuiava-3]

TASK [influxdb : Configure Telegraf] *******************************************
ok: [andriikuiava-3]

TASK [influxdb : Ensure Telegraf is running and enabled] ***********************
ok: [andriikuiava-3]

TASK [influxdb : Download InfluxDB Stats Exporter binary] **********************
ok: [andriikuiava-3]

TASK [influxdb : Create systemd service for InfluxDB Stats Exporter] ***********
ok: [andriikuiava-3]

TASK [influxdb : Ensure InfluxDB Stats Exporter is running and enabled] ********
ok: [andriikuiava-3]

TASK [influxdb : Ensure /home/backup/influxdb directory exists] ****************
ok: [andriikuiava-3]

TASK [influxdb : Ensure backup directory exists] *******************************
ok: [andriikuiava-3]

TASK [influxdb : Configure InfluxDB backup cron job] ***************************
ok: [andriikuiava-3]

TASK [influxdb : Add CNAME for InfluxDB] ***************************************
ok: [andriikuiava-3]

PLAY [Haproxy tasks] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [haproxy : Install haproxy] ***********************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [haproxy : Copy the Haproxy config] ***************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [haproxy : Ensure HAProxy is enabled and started] *************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [haproxy : Install prometheus-haproxy-exporter] ***************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [haproxy : Update prometheus-haproxy-exporter ARGS] ***********************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [haproxy : Ensure prometheus-haproxy-exporter is running] *****************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [haproxy : Ensure prometheus-haproxy-exporter is enabled and started] *****
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [haproxy : Add CNAME for HAProxy instances] *******************************
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-1]
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-2]

PLAY [Keepalived tasks] ********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [keepalived : Install keepalived] *****************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [keepalived : Copy check script to keepalived_script user's home folder] ***
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [keepalived : Copy the Keepalived config] *********************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [keepalived : Download Keepalived Exporter] *******************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [keepalived : Extract Keepalived Exporter] ********************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [keepalived : Create systemd unit file] ***********************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [keepalived : Start the service] ******************************************
ok: [andriikuiava-2] => (item=keepalived)
ok: [andriikuiava-1] => (item=keepalived)
ok: [andriikuiava-2] => (item=keepalived-exporter)
ok: [andriikuiava-1] => (item=keepalived-exporter)

PLAY RECAP *********************************************************************
andriikuiava-1             : ok=89   changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
andriikuiava-2             : ok=89   changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
andriikuiava-3             : ok=85   changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

+ ansible all -b -m reboot -a test_command=uptime
andriikuiava-3 | CHANGED => {
    "changed": true,
    "elapsed": 34,
    "rebooted": true
}
andriikuiava-2 | CHANGED => {
    "changed": true,
    "elapsed": 39,
    "rebooted": true
}
andriikuiava-1 | CHANGED => {
    "changed": true,
    "elapsed": 42,
    "rebooted": true
}
+ sleep 15
+ ansible-playbook infra.yaml --diff

PLAY [Always gather facts for all hosts] ***************************************

TASK [Gathering Facts] *********************************************************
[WARNING]: Platform linux on host andriikuiava-3 is using the discovered Python
interpreter at /usr/bin/python3.10, but future installation of another Python
interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
[WARNING]: Platform linux on host andriikuiava-1 is using the discovered Python
interpreter at /usr/bin/python3.10, but future installation of another Python
interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
[WARNING]: Platform linux on host andriikuiava-2 is using the discovered Python
interpreter at /usr/bin/python3.10, but future installation of another Python
interpreter could change the meaning of that path. See
https://docs.ansible.com/ansible-
core/2.17/reference_appendices/interpreter_discovery.html for more information.
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

PLAY [Initial setup] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]
ok: [andriikuiava-3]

TASK [init : Update APT cache] *************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [init : Install Prometheus Node Exporter] *********************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [init : Ensure Prometheus Node Exporter service is running] ***************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [init : Ensure rsyslog is installed] **************************************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [init : Copy rsyslog configuration for Telegraf] **************************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [init : Ensure backup user exists with the correct home directory] ********
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [init : Ensure .ssh directory exists for backup user] *********************
ok: [andriikuiava-1]
ok: [andriikuiava-2]
ok: [andriikuiava-3]

TASK [init : Check if SSH key pair exists] *************************************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [init : Generate SSH key pair for backup user] ****************************
skipping: [andriikuiava-1]
skipping: [andriikuiava-2]
skipping: [andriikuiava-3]

TASK [init : Set permissions on the public key file] ***************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]
ok: [andriikuiava-3]

TASK [init : Ensure known_hosts file exists for backup user] *******************
ok: [andriikuiava-2]
ok: [andriikuiava-1]
ok: [andriikuiava-3]

TASK [init : Ensure backup user can access backup server without prompts] ******
ok: [andriikuiava-2]
ok: [andriikuiava-1]
ok: [andriikuiava-3]

TASK [init : Add backup server to known_hosts] *********************************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [init : Set permissions for backup SSH keys] ******************************
ok: [andriikuiava-2] => (item=id_rsa)
ok: [andriikuiava-1] => (item=id_rsa)
ok: [andriikuiava-3] => (item=id_rsa)
ok: [andriikuiava-2] => (item=id_rsa.pub)
ok: [andriikuiava-3] => (item=id_rsa.pub)
ok: [andriikuiava-1] => (item=id_rsa.pub)

TASK [init : Ensure /home/backup/restore directory exists] *********************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [init : Ensure duplicity is installed] ************************************
[WARNING]: Could not match supplied host pattern, ignoring: children
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

PLAY [DNS Servers] *************************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [bind : Install Bind9] ****************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [bind : Configure DNS forwarders] *****************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [bind : Create master zone file] ******************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [bind : Create reverse zone file] *****************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [bind : Configure Bind9 zones] ********************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [bind : Run handlers] *****************************************************

TASK [bind : Run handlers] *****************************************************

TASK [bind : Run handlers] *****************************************************

TASK [bind : Ensure Bind9 is running and enabled on boot] **********************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [bind : Download Bind9 exporter] ******************************************
ok: [andriikuiava-1]
ok: [andriikuiava-3]
ok: [andriikuiava-2]

TASK [bind : Unarchive Bind9 exporter] *****************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [bind : Create symlink for Bind9 exporter] ********************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [bind : Create systemd service for Bind9 exporter] ************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [bind : Reload systemd] ***************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [bind : Start Bind9 exporter service] *************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]
ok: [andriikuiava-3]

TASK [bind : Add A record for backup server] ***********************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [bind : Add CNAME for Bind9 servers] **************************************
ok: [andriikuiava-3] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-3] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-3] => (item=None)
ok: [andriikuiava-3]
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-2]
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-1]

PLAY [Resolv DNS] **************************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [resolv_dns : Disable systemd-resolved] ***********************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]
ok: [andriikuiava-3]

TASK [resolv_dns : Create resolv.conf with DNS settings] ***********************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

PLAY [Database Server] *********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Install MySQL server] ********************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Install PyMySQL] *************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Ensure MySQL service is running] *********************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Wait for MySQL to be ready] **************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Create MySQL override configuration] *****************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : MySQL database] **************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : MySQL user] ******************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Install MySQL exporter] ******************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Create MySQL user for exporter] **********************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Configure MySQL exporter credentials] ****************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Ensure /home/backup/mysql directory exists] **********************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Create MySQL backup user] ****************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Create MySQL client configuration file for backup user] **********
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Ensure /home/backup/mysql directory exists] **********************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Create Cron job for MySQL backups] *******************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Create MySQL replication user] ***********************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [mysql : Set MySQL read_only mode dynamically] ****************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [mysql : Add CNAME for MySQL instances] ***********************************
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2]
ok: [andriikuiava-1]

PLAY [Prometheus Servers] ******************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]

TASK [prometheus : Install Prometheus] *****************************************
ok: [andriikuiava-3]

TASK [prometheus : Configure Prometheus Service] *******************************
ok: [andriikuiava-3]

TASK [prometheus : Configure Prometheus] ***************************************
ok: [andriikuiava-3]

TASK [prometheus : Run Prometheus] *********************************************
ok: [andriikuiava-3]

TASK [prometheus : Install Nginx] **********************************************
ok: [andriikuiava-3]

TASK [prometheus : Start Nginx] ************************************************
ok: [andriikuiava-3]

TASK [prometheus : Add CNAME for Prometheus] ***********************************
ok: [andriikuiava-3]

PLAY [Docker] ******************************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [docker : Install Docker.io package] **************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]
ok: [andriikuiava-3]

TASK [docker : Install python3-docker package] *********************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [docker : Ensure Docker daemon is running and enabled] ********************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

PLAY [Grafana Tasks] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]

TASK [grafana : Create required directories for Grafana provisioning] **********
ok: [andriikuiava-3] => (item=dashboards)
ok: [andriikuiava-3] => (item=datasources)

TASK [grafana : Copy grafana.ini configuration] ********************************
ok: [andriikuiava-3]

TASK [grafana : Copy dashboard provisioning configuration] *********************
ok: [andriikuiava-3]

TASK [grafana : Copy datasource provisioning configuration] ********************
ok: [andriikuiava-3]

TASK [grafana : Copy dashboards JSON files] ************************************
ok: [andriikuiava-3] => (item=backups.json)
ok: [andriikuiava-3] => (item=main.json)
ok: [andriikuiava-3] => (item=mysql.json)
ok: [andriikuiava-3] => (item=syslog.json)

TASK [grafana : Ensure Grafana container is running] ***************************
ok: [andriikuiava-3]

TASK [grafana : Add CNAME for Grafana] *****************************************
ok: [andriikuiava-3]

PLAY [Agama tasks] *************************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [agama : Create /opt/agama directory] *************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [agama : Download Agama files] ********************************************
ok: [andriikuiava-2] => (item={'dest': 'agama.py', 'url': 'https://raw.githubusercontent.com/hudolejev/agama/master/agama.py'})
ok: [andriikuiava-1] => (item={'dest': 'agama.py', 'url': 'https://raw.githubusercontent.com/hudolejev/agama/master/agama.py'})
ok: [andriikuiava-2] => (item={'dest': 'Dockerfile', 'url': 'https://raw.githubusercontent.com/hudolejev/agama/master/Dockerfile'})
ok: [andriikuiava-1] => (item={'dest': 'Dockerfile', 'url': 'https://raw.githubusercontent.com/hudolejev/agama/master/Dockerfile'})

TASK [agama : Build Agama Docker image] ****************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [agama : Create Agama Containers] *****************************************
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [agama : Add CNAME for Agama containers] **********************************
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-2]
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-1]

PLAY [Agama client tasks] ******************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]

TASK [agama_client : Install fping] ********************************************
ok: [andriikuiava-3]

TASK [agama_client : Copy agama-client script to /usr/local/bin] ***************
ok: [andriikuiava-3]

TASK [agama_client : Create agama-client user] *********************************
ok: [andriikuiava-3]

TASK [agama_client : Create directory for agama-client configuration] **********
ok: [andriikuiava-3]

TASK [agama_client : Copy agama-client configuration file] *********************
ok: [andriikuiava-3]

TASK [agama_client : Copy agama-client systemd service file] *******************
ok: [andriikuiava-3]

TASK [agama_client : Enable and start agama-client service] ********************
ok: [andriikuiava-3]

PLAY [Web server tasks] ********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]
ok: [andriikuiava-3]

TASK [nginx : Install nginx] ***************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [nginx : Copy Nginx config to sites-enabled] ******************************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [nginx : Ensure Nginx service is running] *********************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [nginx : Install Nginx exporter] ******************************************
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [nginx : Add scrape-uri to prometheus-nginx-exporter systemd service] *****
ok: [andriikuiava-3]
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [nginx : Reload systemd daemon] *******************************************
ok: [andriikuiava-2]
ok: [andriikuiava-3]
ok: [andriikuiava-1]

TASK [nginx : Make sure Nginx exporter is running] *****************************
ok: [andriikuiava-3]
ok: [andriikuiava-1]
ok: [andriikuiava-2]

PLAY [Influxdb tasks] **********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-3]

TASK [influxdb : Download InfluxDB .deb package] *******************************
ok: [andriikuiava-3]

TASK [influxdb : Install InfluxDB] *********************************************
ok: [andriikuiava-3]

TASK [influxdb : Ensure InfluxDB is enabled and started] ***********************
ok: [andriikuiava-3]

TASK [influxdb : Install Telegraf] *********************************************
ok: [andriikuiava-3]

TASK [influxdb : Configure Telegraf] *******************************************
ok: [andriikuiava-3]

TASK [influxdb : Ensure Telegraf is running and enabled] ***********************
ok: [andriikuiava-3]

TASK [influxdb : Download InfluxDB Stats Exporter binary] **********************
ok: [andriikuiava-3]

TASK [influxdb : Create systemd service for InfluxDB Stats Exporter] ***********
ok: [andriikuiava-3]

TASK [influxdb : Ensure InfluxDB Stats Exporter is running and enabled] ********
ok: [andriikuiava-3]

TASK [influxdb : Ensure /home/backup/influxdb directory exists] ****************
ok: [andriikuiava-3]

TASK [influxdb : Ensure backup directory exists] *******************************
ok: [andriikuiava-3]

TASK [influxdb : Configure InfluxDB backup cron job] ***************************
ok: [andriikuiava-3]

TASK [influxdb : Add CNAME for InfluxDB] ***************************************
ok: [andriikuiava-3]

PLAY [Haproxy tasks] ***********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [haproxy : Install haproxy] ***********************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [haproxy : Copy the Haproxy config] ***************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [haproxy : Ensure HAProxy is enabled and started] *************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [haproxy : Install prometheus-haproxy-exporter] ***************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [haproxy : Update prometheus-haproxy-exporter ARGS] ***********************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [haproxy : Ensure prometheus-haproxy-exporter is running] *****************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [haproxy : Ensure prometheus-haproxy-exporter is enabled and started] *****
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [haproxy : Add CNAME for HAProxy instances] *******************************
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-2] => (item=None)
ok: [andriikuiava-2]
ok: [andriikuiava-1] => (item=None)
ok: [andriikuiava-1]

PLAY [Keepalived tasks] ********************************************************

TASK [Gathering Facts] *********************************************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [keepalived : Install keepalived] *****************************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [keepalived : Copy check script to keepalived_script user's home folder] ***
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [keepalived : Copy the Keepalived config] *********************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [keepalived : Download Keepalived Exporter] *******************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [keepalived : Extract Keepalived Exporter] ********************************
ok: [andriikuiava-1]
ok: [andriikuiava-2]

TASK [keepalived : Create systemd unit file] ***********************************
ok: [andriikuiava-2]
ok: [andriikuiava-1]

TASK [keepalived : Start the service] ******************************************
ok: [andriikuiava-1] => (item=keepalived)
ok: [andriikuiava-2] => (item=keepalived)
ok: [andriikuiava-2] => (item=keepalived-exporter)
ok: [andriikuiava-1] => (item=keepalived-exporter)

PLAY RECAP *********************************************************************
andriikuiava-1             : ok=89   changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
andriikuiava-2             : ok=89   changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
andriikuiava-3             : ok=85   changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

+ date
Fri Jan  3 11:57:36 EET 2025
